{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Members - {{ club.name }}{% endblock %}

{% block content %}
<div class="container">
    <section class="manage-emails-page">
        <div class="page-header">
            <a href="{% url 'people:user_profile' %}" class="back-link">‚Üê Back to Profile</a>
            <h1>Manage Members: {{ club.name }}</h1>
        </div>
        
        {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Info Box -->
        <div class="info-box">
            <p><strong>Manage Your Club Members:</strong> This page shows only members you have created. Add email addresses to allow club members to create accounts and join this club. All members created through this will be set as <strong>Club Member</strong> type. Permissions can be granted later by power users.</p>
        </div>
        
        <!-- Filters and Actions -->
        <div class="emails-toolbar">
            <div class="toolbar-left">
                <form method="get" class="filter-form">
                    <input type="text" name="search" placeholder="Search emails..." value="{{ search_query }}" class="search-input">
                    <button type="submit" class="filter-btn">Filter</button>
                    <a href="{% url 'clubs:manage_allowed_emails' club.pk %}" class="clear-btn">Clear</a>
                </form>
            </div>
            <div class="toolbar-right">
                <a href="{% url 'clubs:create_allowed_email' club.pk %}" class="action-btn success">+ Allow Email for Sign Up</a>
            </div>
        </div>
        
        <!-- Emails Table -->
        <div class="emails-table-container">
            {% if allowed_emails %}
            <table class="emails-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>User Type</th>
                        <th>Power User</th>
                        <th>Status</th>
                        <th>Member Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in allowed_emails %}
                    <tr>
                        <td><strong>{{ email.email }}</strong></td>
                        <td>
                            <span class="type-badge type-club_member">
                                {{ email.get_user_type_display }}
                            </span>
                        </td>
                        <td>
                            {% if email.is_power_user %}
                            <span class="level-badge" style="background: color-mix(in srgb, #007bff 15%, transparent); color: #007bff;">
                                Yes
                            </span>
                            {% else %}
                            <span class="level-badge level-1">
                                No
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if email.is_active %}
                            <span class="status-badge status-active">Active</span>
                            {% else %}
                            <span class="status-badge status-inactive">Inactive</span>
                            {% endif %}
                            {% if email.is_blocked %}
                            <span class="status-badge status-blocked">Blocked</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if email.base_user %}
                                {% if email.base_user.club_member_profile %}
                                    <span class="status-badge status-active">Signed Up</span>
                                    <br><small style="color: var(--text-secondary);">{{ email.base_user.club_member_profile.name }}</small>
                                {% else %}
                                    <span class="status-badge" style="background: #ffc107; color: #000;">Pending</span>
                                {% endif %}
                            {% else %}
                                <span class="status-badge" style="background: #ffc107; color: #000;">Not Signed Up</span>
                            {% endif %}
                        </td>
                        <td>{{ email.created_at|date:"M d, Y" }}</td>
                        <td class="actions-col">
                            {% if email.created_by == user %}
                            <a href="{% url 'clubs:delete_allowed_email' club.pk email.pk %}" class="action-icon-btn delete-icon-btn" title="Delete (You created this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </a>
                            {% else %}
                            <span class="action-icon-btn delete-icon-btn disabled" title="You can only delete emails you created" style="opacity: 0.5; cursor: not-allowed;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-emails-message">
                <p>No members found. {% if search_query %}Try a different search term.{% else %}You haven't created any club members yet. Add an email address to allow club members to sign up and join this club.{% endif %}</p>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<style>
.manage-emails-page {
    background: var(--bg-primary);
    border-radius: 15px;
    box-shadow: 0 8px 25px var(--shadow);
    padding: 2.5rem;
    margin-bottom: 3rem;
}

.page-header {
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.page-header h1 {
    font-size: 2.8rem;
    color: var(--color-primary);
    margin: 0;
    text-align: center;
    flex-grow: 1;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
}

.back-link:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
}

.messages-container {
    margin-bottom: 1.5rem;
}

.alert {
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-weight: 500;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.info-box {
    background: color-mix(in srgb, var(--color-primary) 10%, var(--bg-secondary));
    border: 1px solid var(--color-primary);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    color: var(--text-primary);
}

.info-box p {
    margin: 0;
    font-size: 0.95rem;
}

.emails-toolbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 10px;
    border: 1px solid var(--border-color);
}

.toolbar-left, .toolbar-right {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
}

.filter-form {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.search-input {
    padding: 0.6rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: border-color 0.3s ease;
    min-width: 250px;
}

.search-input:focus {
    border-color: var(--color-primary);
    outline: none;
}

.filter-btn, .clear-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.filter-btn {
    background: var(--color-primary);
    color: white;
}

.filter-btn:hover {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
}

.clear-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.clear-btn:hover {
    background: color-mix(in srgb, var(--color-primary) 10%, var(--bg-tertiary));
    color: var(--color-primary);
    border-color: var(--color-primary);
    transform: translateY(-1px);
}

.action-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.action-btn.success {
    background: var(--color-primary);
    color: white;
}

.action-btn.success:hover {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
}

.emails-table-container {
    background: var(--bg-primary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.emails-table {
    width: 100%;
    border-collapse: collapse;
}

.emails-table thead {
    background: var(--bg-tertiary);
}

.emails-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
    border-bottom: 2px solid var(--border-color);
}

.emails-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.emails-table tbody tr:hover {
    background: var(--bg-secondary);
}

.emails-table tbody tr:last-child td {
    border-bottom: none;
}

.type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.type-badge.type-club_member {
    background: color-mix(in srgb, #28a745 15%, transparent);
    color: #28a745;
}

.level-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.level-badge.level-1 {
    background: color-mix(in srgb, #6c757d 15%, transparent);
    color: #6c757d;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-right: 0.5rem;
}

.status-badge.status-active {
    background: color-mix(in srgb, #28a745 15%, transparent);
    color: #28a745;
}

.status-badge.status-inactive {
    background: color-mix(in srgb, #ffc107 15%, transparent);
    color: #856404;
}

.status-badge.status-blocked {
    background: color-mix(in srgb, #dc3545 15%, transparent);
    color: #dc3545;
}

.you-badge {
    font-size: 0.75rem;
    color: var(--color-primary);
    font-weight: 600;
    margin-left: 0.25rem;
}

.actions-col {
    white-space: nowrap;
}

.action-icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    background: transparent;
}

.delete-icon-btn {
    color: #dc3545;
    background: color-mix(in srgb, #dc3545 15%, transparent);
}

.delete-icon-btn:hover {
    background: #dc3545;
    color: white;
}

.no-emails-message {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .manage-emails-page {
        padding: 1.5rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
    }
    
    .emails-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-left, .toolbar-right {
        width: 100%;
        justify-content: center;
    }
    
    .filter-form {
        flex-direction: column;
        width: 100%;
    }
    
    .search-input, .filter-btn, .clear-btn, .action-btn {
        width: 100%;
    }
    
    .emails-table {
        font-size: 0.85rem;
    }
    
    .emails-table th,
    .emails-table td {
        padding: 0.6rem 0.5rem;
    }
}
</style>
{% endblock %}

