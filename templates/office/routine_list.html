{% extends 'base.html' %}
{% load static %}

{% block title %}Class Routines - CSE UAP{% endblock %}

{% block content %}
<div class="container">
    <section class="routines-list-page">
        <div class="routines-header">
            <a href="{% url 'home' %}" class="back-link">‚Üê Back to Home</a>
            <h1 class="routines-title">Class Routines</h1>
            <p class="routines-subtitle">View class timetables by academic year, semester, and section</p>
        </div>
        
        <div class="routines-content">
            <!-- Search and Filter Section -->
            <div class="routines-filters">
                <form method="get" class="filter-form">
                    <div class="filter-group">
                        <label for="search-input">Search:</label>
                        <input type="text" name="search" id="search-input" placeholder="Search routines..." value="{{ search_query }}" class="search-input">
                    </div>
                    <div class="filter-group">
                        <label for="year-select">Year:</label>
                        <select name="year" id="year-select" class="filter-select">
                            <option value="">All Years</option>
                            {% for year in years %}
                            <option value="{{ year }}" {% if year_filter == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="semester-select">Semester:</label>
                        <select name="semester" id="semester-select" class="filter-select">
                            <option value="">All Semesters</option>
                            {% for code, display in SEMESTER_CHOICES %}
                            <option value="{{ code }}" {% if semester_filter == code %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="year_semester-select">Year-Semester:</label>
                        <select name="year_semester" id="year_semester-select" class="filter-select">
                            <option value="">All</option>
                            {% for code, display in YEAR_SEMESTER_CHOICES %}
                            <option value="{{ code }}" {% if year_semester_filter == code %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="section-select">Section:</label>
                        <select name="section" id="section-select" class="filter-select">
                            <option value="">All Sections</option>
                            {% for code, display in SECTION_CHOICES %}
                            <option value="{{ code }}" {% if section_filter == code %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="filter-btn">Apply</button>
                    {% if search_query or year_filter or semester_filter or year_semester_filter or section_filter %}
                    <a href="{% url 'office:routine_list' %}" class="clear-btn">Clear</a>
                    {% endif %}
                </form>
            </div>

            <!-- Routines Grid -->
            {% if routines %}
            <div class="routines-grid">
                {% for routine in routines %}
                <div class="routine-card" onclick="openRoutineModal('{{ routine.routine_image.url }}', '{{ routine.academic_year }} {{ routine.get_semester_display }} - {{ routine.get_year_semester_display }} Section {{ routine.section }}')">
                    <div class="routine-card-header">
                        <div class="routine-badge">
                            {{ routine.academic_year }} {{ routine.get_semester_display }}
                        </div>
                        <div class="routine-section-badge">Sec {{ routine.section }}</div>
                    </div>
                    <div class="routine-card-body">
                        <div class="routine-image-preview">
                            <img src="{{ routine.routine_image.url }}" alt="Routine {{ routine.academic_year }} {{ routine.semester }}" loading="lazy">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Routine Image Modal -->
            <div id="routineModal" class="routine-modal" onclick="closeRoutineModal(event)">
                <div class="routine-modal-content" onclick="event.stopPropagation()">
                    <button class="routine-modal-close" onclick="closeRoutineModal()" aria-label="Close">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <div class="routine-modal-header">
                        <h3 id="routineModalTitle"></h3>
                    </div>
                    <div class="routine-modal-body">
                        <img id="routineModalImage" src="" alt="Routine Image">
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% if routines.has_other_pages %}
            <div class="pagination-wrapper">
                <div class="pagination">
                    {% if routines.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if semester_filter %}&semester={{ semester_filter }}{% endif %}{% if year_semester_filter %}&year_semester={{ year_semester_filter }}{% endif %}{% if section_filter %}&section={{ section_filter }}{% endif %}" class="pagination-btn pagination-first">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7"></polyline>
                            <polyline points="18 17 13 12 18 7"></polyline>
                        </svg>
                        First
                    </a>
                    <a href="?page={{ routines.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if semester_filter %}&semester={{ semester_filter }}{% endif %}{% if year_semester_filter %}&year_semester={{ year_semester_filter }}{% endif %}{% if section_filter %}&section={{ section_filter }}{% endif %}" class="pagination-btn pagination-prev">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Previous
                    </a>
                    {% else %}
                    <span class="pagination-btn pagination-disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7"></polyline>
                            <polyline points="18 17 13 12 18 7"></polyline>
                        </svg>
                        First
                    </span>
                    <span class="pagination-btn pagination-disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Previous
                    </span>
                    {% endif %}

                    <div class="pagination-pages">
                        {% for num in routines.paginator.page_range %}
                            {% if routines.number == num %}
                            <span class="pagination-page pagination-active">{{ num }}</span>
                            {% elif num > routines.number|add:'-3' and num < routines.number|add:'3' %}
                            <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if semester_filter %}&semester={{ semester_filter }}{% endif %}{% if year_semester_filter %}&year_semester={{ year_semester_filter }}{% endif %}{% if section_filter %}&section={{ section_filter }}{% endif %}" class="pagination-page">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                    </div>

                    {% if routines.has_next %}
                    <a href="?page={{ routines.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if semester_filter %}&semester={{ semester_filter }}{% endif %}{% if year_semester_filter %}&year_semester={{ year_semester_filter }}{% endif %}{% if section_filter %}&section={{ section_filter }}{% endif %}" class="pagination-btn pagination-next">
                        Next
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>
                    <a href="?page={{ routines.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if semester_filter %}&semester={{ semester_filter }}{% endif %}{% if year_semester_filter %}&year_semester={{ year_semester_filter }}{% endif %}{% if section_filter %}&section={{ section_filter }}{% endif %}" class="pagination-btn pagination-last">
                        Last
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="13 17 18 12 13 7"></polyline>
                            <polyline points="6 17 11 12 6 7"></polyline>
                        </svg>
                    </a>
                    {% else %}
                    <span class="pagination-btn pagination-disabled">
                        Next
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </span>
                    <span class="pagination-btn pagination-disabled">
                        Last
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="13 17 18 12 13 7"></polyline>
                            <polyline points="6 17 11 12 6 7"></polyline>
                        </svg>
                    </span>
                    {% endif %}
                </div>
                <div class="pagination-info">
                    Showing {{ routines.start_index }} to {{ routines.end_index }} of {{ routines.paginator.count }} routines
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <h3>No routines found</h3>
                <p>No class routines match your search criteria.</p>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<style>
.routines-list-page {
    padding: 2rem 0;
}

.routines-header {
    margin-bottom: 2rem;
}

.routines-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-primary);
    margin: 1rem 0 0.5rem;
}

.routines-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.routines-filters {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
}

.filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
    min-width: 150px;
}

.filter-group label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

.search-input, .filter-select {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.search-input:focus, .filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
}

.filter-btn, .clear-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.filter-btn {
    background: var(--color-primary);
    color: white;
}

.filter-btn:hover {
    background: var(--color-primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--glow-shadow);
}

.clear-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.clear-btn:hover {
    background: var(--border-color);
}

.routines-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.routine-card {
    background: var(--bg-secondary);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px var(--shadow);
    transition: all 0.3s ease;
    cursor: pointer;
}

.routine-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px var(--shadow-lg);
}

.routine-card-header {
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.routine-badge {
    background: var(--color-primary);
    color: white;
    padding: 0.35rem 0.7rem;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.85rem;
}

.routine-section-badge {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.8rem;
}

.routine-card-body {
    padding: 0.75rem;
}

.routine-image-preview {
    width: 100%;
    height: 240px;
    overflow: hidden;
    border-radius: 8px;
    background: var(--bg-primary);
}

.routine-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.routine-card:hover .routine-image-preview img {
    transform: scale(1.05);
}

/* Routine Modal */
.routine-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.routine-modal.active {
    display: flex;
    opacity: 1;
}

.routine-modal-content {
    position: relative;
    width: 90vw;
    height: 90vh;
    max-width: 90vw;
    max-height: 90vh;
    background: var(--bg-secondary);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.routine-modal.active .routine-modal-content {
    transform: scale(1);
}

.routine-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    transition: all 0.3s ease;
}

.routine-modal-close:hover {
    background: rgba(0, 0, 0, 0.8);
    border-color: rgba(255, 255, 255, 0.5);
    transform: rotate(90deg);
}

.routine-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.routine-modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.routine-modal-body {
    padding: 1.5rem;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    min-height: 0;
}

.routine-modal-body img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    display: block;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
}

.empty-state svg {
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

@media (max-width: 768px) {
    .routines-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-form {
        flex-direction: column;
    }
    
    .filter-group {
        min-width: 100%;
    }
}

/* Remove underlines from anchor tags and make them follow theme */
a {
    text-decoration: none;
    color: inherit;
}

.back-link {
    color: var(--color-primary);
    transition: color 0.3s ease;
}

.back-link:hover {
    color: var(--color-primary-hover);
}

.routine-link {
    text-decoration: none;
    color: inherit;
}

.view-btn {
    text-decoration: none;
}

.clear-btn {
    text-decoration: none;
}

.pagination-btn, .pagination-page {
    text-decoration: none;
}

.pagination-btn:hover, .pagination-page:hover {
    color: var(--color-primary);
}

@media (max-width: 768px) {
    .routine-modal {
        padding: 1rem;
    }
    
    .routine-modal-content {
        width: 95vw;
        height: 95vh;
        max-width: 95vw;
        max-height: 95vh;
    }
    
    .routine-modal-header {
        padding: 1rem;
    }
    
    .routine-modal-header h3 {
        font-size: 1rem;
    }
    
    .routine-modal-body {
        padding: 1rem;
    }
    
    .routine-modal-close {
        top: 0.5rem;
        right: 0.5rem;
        width: 36px;
        height: 36px;
    }
}
</style>

<script>
function openRoutineModal(imageUrl, title) {
    const modal = document.getElementById('routineModal');
    const modalImage = document.getElementById('routineModalImage');
    const modalTitle = document.getElementById('routineModalTitle');
    
    modalImage.src = imageUrl;
    modalTitle.textContent = title;
    modal.classList.add('active');
    
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
}

function closeRoutineModal(event) {
    // If event is provided and it's from clicking the modal backdrop, close
    // If event is from the close button, it will be undefined or the button click
    if (event && event.target !== event.currentTarget) {
        return; // Don't close if clicking inside the modal content
    }
    
    const modal = document.getElementById('routineModal');
    modal.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeRoutineModal();
    }
});
</script>
{% endblock %}

