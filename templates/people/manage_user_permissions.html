{% extends 'base.html' %}
{% load static %}
{% load user_filters %}

{% block title %}Manage Permissions for {{ target_user.email }} - CSE UAP{% endblock %}

{% block content %}
<div class="container">
    <section class="user-profile-page">
        <div class="profile-header">
            {% if target_user.id == user.id %}
                <a href="{% url 'people:user_profile' %}" class="back-link">← Back to Profile</a>
            {% else %}
                <a href="{% url 'people:manage_user_permissions_list' %}" class="back-link">← Back to User List</a>
            {% endif %}
            <h1 class="page-title">
                {% if target_user.id == user.id %}
                    Manage Your Permissions
                {% else %}
                    Manage Permissions for {{ target_user.email }}
                {% endif %}
            </h1>
        </div>
        
        <!-- Target User Info -->
        <div class="user-info-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <strong style="color: var(--text-primary); font-size: 1rem;">{{ target_user.get_full_name|default:target_user.email }}</strong>
                    <span style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 0.5rem;">{{ target_user.email }}</span>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="padding: 0.25rem 0.75rem; background: color-mix(in srgb, var(--color-primary) 15%, transparent); color: var(--color-primary); border-radius: 6px; font-size: 0.85rem;">
                        {% if target_user.user_type %}{{ target_user.user_type|title }}{% else %}General{% endif %}
                    </span>
                    {% if target_user.is_power_user %}
                        <span style="padding: 0.25rem 0.75rem; background: #e8f5e9; color: #2e7d32; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">Power User</span>
                    {% endif %}
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                        <strong>{{ user_permission_codenames|length }}</strong> permissions
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Permissions Form -->
        <form method="post" action="{% if target_user.id == user.id %}{% url 'people:manage_own_permissions' %}{% else %}{% url 'people:manage_user_permissions' target_user.id %}{% endif %}" id="permissions-form">
            {% csrf_token %}
            
            <!-- Select All Controls -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600; color: var(--text-primary);">
                    <input type="checkbox" id="select-all-permissions" style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Select All Permissions</span>
                </label>
                {% if target_user.is_power_user %}
                <span style="padding: 0.25rem 0.75rem; background: color-mix(in srgb, var(--color-primary) 15%, transparent); color: var(--color-primary); border-radius: 6px; font-size: 0.85rem;">
                    Power User: All permissions granted by default (uncheck to revoke)
                </span>
                {% endif %}
            </div>
            
            <div class="permissions-form">
                {% for category, permissions in permissions_by_category.items %}
                    <div class="permission-category" style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-primary);">
                            <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">
                                {{ category|title }}
                            </h3>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; color: var(--text-secondary);">
                                <input type="checkbox" class="select-category-all" data-category="{{ category }}" style="width: 16px; height: 16px; cursor: pointer;">
                                <span>Select All</span>
                            </label>
                        </div>
                        
                        <div class="permissions-list" style="display: grid; gap: 0.5rem;">
                            {% for permission in permissions %}
                                {% with is_granted=permission.codename|in_list:user_permission_codenames %}
                                <div class="permission-item {% if not is_granted %}permission-not-granted{% endif %}" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: {% if is_granted %}color-mix(in srgb, var(--color-primary) 8%, var(--bg-secondary)){% else %}var(--bg-secondary){% endif %}; transition: all 0.2s;">
                                    <input 
                                        type="checkbox" 
                                        name="permissions" 
                                        value="{{ permission.codename }}"
                                        id="perm_{{ permission.codename }}"
                                        {% if is_granted %}checked{% endif %}
                                        class="permission-checkbox"
                                        style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;"
                                    >
                                    <label for="perm_{{ permission.codename }}" style="flex: 1; cursor: pointer; margin: 0;">
                                        <div style="font-weight: 600; color: {% if is_granted %}var(--text-primary){% else %}var(--text-secondary); opacity: 0.6;{% endif %}; margin-bottom: 0.25rem;">
                                            {{ permission.name }}
                                        </div>
                                        {% if permission.description %}
                                            <div style="color: var(--text-secondary); font-size: 0.85rem; {% if not is_granted %}opacity: 0.5;{% endif %}">
                                                {{ permission.description }}
                                            </div>
                                        {% endif %}
                                        {% if is_granted %}
                                            {% with status=permission_status|get_item:permission.codename %}
                                                <div style="margin-top: 0.25rem; color: #28a745; font-size: 0.8rem;">
                                                    ✓ Granted {{ status.granted_at|date:"M d, Y" }}
                                                </div>
                                            {% endwith %}
                                        {% else %}
                                            <div style="margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.8rem; opacity: 0.6;">
                                                Not granted
                                            </div>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Submit Button -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--border-color); display: flex; gap: 1rem; align-items: center;">
                <button type="submit" class="btn-primary">
                    Save Permissions
                </button>
                {% if target_user.id == user.id %}
                    <a href="{% url 'people:user_profile' %}" class="btn-secondary">
                        Cancel
                    </a>
                {% else %}
                    <a href="{% url 'people:manage_user_permissions_list' %}" class="btn-secondary">
                        Cancel
                    </a>
                {% endif %}
            </div>
        </form>
    </section>
</div>

<style>
    .permission-item:hover {
        border-color: var(--color-primary) !important;
        box-shadow: 0 2px 8px color-mix(in srgb, var(--color-primary) 15%, transparent);
    }
    
    .permission-item input[type="checkbox"]:checked + label {
        color: var(--color-primary);
    }
    
    /* Grayed out style for permissions not granted */
    .permission-not-granted {
        opacity: 0.6;
    }
    
    .permission-not-granted:hover {
        opacity: 0.85;
    }
    
    .permission-not-granted .permission-checkbox {
        opacity: 0.7;
    }
    
    .permission-not-granted .permission-checkbox:checked {
        opacity: 1;
    }
    
    /* Button styles following theme */
    .btn-primary, .btn-secondary {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        font-size: 1rem;
    }
    
    .btn-primary {
        background: var(--color-primary);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--color-primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--glow-shadow);
    }
    
    .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
        background: var(--border-color);
        transform: translateY(-1px);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-permissions');
    const categorySelectAllCheckboxes = document.querySelectorAll('.select-category-all');
    const permissionCheckboxes = document.querySelectorAll('input[name="permissions"]');
    
    // Select All checkbox functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            permissionCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            // Update category checkboxes
            categorySelectAllCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
        });
    }
    
    // Category Select All functionality
    categorySelectAllCheckboxes.forEach(categoryCheckbox => {
        categoryCheckbox.addEventListener('change', function() {
            const category = this.getAttribute('data-category');
            const categoryDiv = this.closest('.permission-category');
            const categoryPermissionCheckboxes = categoryDiv.querySelectorAll('input[name="permissions"]');
            categoryPermissionCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            // Update main select all checkbox
            updateSelectAllCheckbox();
        });
    });
    
    // Individual checkbox change - update category and main select all
    permissionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateCategorySelectAll(this);
            updateSelectAllCheckbox();
        });
    });
    
    // Update category select all checkbox based on individual checkboxes
    function updateCategorySelectAll(checkbox) {
        const categoryDiv = checkbox.closest('.permission-category');
        if (!categoryDiv) return;
        const categoryCheckbox = categoryDiv.querySelector('.select-category-all');
        if (!categoryCheckbox) return;
        const categoryPermissionCheckboxes = categoryDiv.querySelectorAll('input[name="permissions"]');
        const allChecked = Array.from(categoryPermissionCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(categoryPermissionCheckboxes).some(cb => cb.checked);
        categoryCheckbox.checked = allChecked;
        categoryCheckbox.indeterminate = someChecked && !allChecked;
    }
    
    // Update main select all checkbox based on all permission checkboxes
    function updateSelectAllCheckbox() {
        if (!selectAllCheckbox) return;
        const allChecked = Array.from(permissionCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(permissionCheckboxes).some(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
    
    // Initialize category checkboxes on load
    categorySelectAllCheckboxes.forEach(categoryCheckbox => {
        const categoryDiv = categoryCheckbox.closest('.permission-category');
        if (categoryDiv) {
            const categoryPermissionCheckboxes = categoryDiv.querySelectorAll('input[name="permissions"]');
            const allChecked = Array.from(categoryPermissionCheckboxes).every(cb => cb.checked);
            categoryCheckbox.checked = allChecked;
        }
    });
    
    // Initialize main select all checkbox on load
    updateSelectAllCheckbox();
});
</script>
{% endblock %}

