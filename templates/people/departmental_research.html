{% extends 'base.html' %}
{% load static user_filters %}

{% block title %}Departmental Research - CSE UAP{% endblock %}

{% block extra_css %}
<!-- Chart.js will be loaded before script section -->
{% endblock %}

{% block content %}
<div class="container">
    <section class="research-page-section">
        <!-- Header -->
        <div class="research-header">
            <div class="header-content">
                <div class="header-text">
                    <h1>Departmental Research</h1>
                    <p class="subtitle">Publications and research contributions from our faculty members</p>
                </div>
                <a href="{% url 'people:faculty_list' %}" class="back-link">
                    ‚Üê Back to Faculty
                </a>
            </div>
        </div>

        <!-- Comprehensive Filter Bar -->
        <div class="comprehensive-filter-bar">
            <form method="get" action="{% url 'people:departmental_research' %}" id="filter-form" class="filter-form">
                <input type="hidden" name="tab" id="current-tab-input" value="{{ request.GET.tab|default:'stats' }}">
                
                <div class="filter-group">
                    <label class="filter-label">Time Period:</label>
                    <div class="filter-buttons">
                        <button type="submit" name="period" value="all_time" class="filter-btn {% if period == 'all_time' %}active{% endif %}">All Time</button>
                        <button type="submit" name="period" value="last_2_years" class="filter-btn {% if period == 'last_2_years' %}active{% endif %}">Last 2 Years</button>
                        <button type="submit" name="period" value="current_year" class="filter-btn {% if period == 'current_year' %}active{% endif %}">{{ current_year }}</button>
                        <button type="submit" name="period" value="custom" class="filter-btn {% if period == 'custom' %}active{% endif %}" id="custom-period-btn">Custom Range</button>
                    </div>
                    <div class="custom-year-range {% if period != 'custom' %}hidden{% endif %}" id="custom-year-range">
                        <input type="number" name="year_from" placeholder="From Year" value="{{ year_from }}" min="{{ min_year }}" max="{{ max_year }}" class="year-input">
                        <span>to</span>
                        <input type="number" name="year_to" placeholder="To Year" value="{{ year_to }}" min="{{ min_year }}" max="{{ max_year }}" class="year-input">
                        <button type="submit" class="apply-btn" id="apply-year-range-btn">Apply</button>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Publication Type:</label>
                    <select name="type" class="filter-select">
                        <option value="all" {% if pub_type == 'all' %}selected{% endif %}>All Types</option>
                        {% for code, label in type_choices.items %}
                        <option value="{{ code }}" {% if pub_type == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Ranking:</label>
                    <select name="ranking" class="filter-select">
                        <option value="all" {% if ranking_filter == 'all' %}selected{% endif %}>All Rankings</option>
                        {% for code, label in ranking_choices.items %}
                        <option value="{{ code }}" {% if ranking_filter == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Sort By:</label>
                    <select name="sort" class="filter-select">
                        <option value="year_desc" {% if sort_by == 'year_desc' %}selected{% endif %}>Year (Newest First)</option>
                        <option value="year_asc" {% if sort_by == 'year_asc' %}selected{% endif %}>Year (Oldest First)</option>
                        <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>Title (A-Z)</option>
                        <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>Title (Z-A)</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-btn {% if request.GET.tab != 'faculty' and request.GET.tab != 'publications' %}active{% endif %}" data-tab="stats">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Statistics
                </button>
                <button class="tab-btn {% if request.GET.tab == 'faculty' %}active{% endif %}" data-tab="faculty">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Faculty Scores
                </button>
                <button class="tab-btn {% if request.GET.tab == 'publications' %}active{% endif %}" data-tab="publications">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    All Publications
                </button>
            </div>

            <!-- Tab Content -->
            <!-- Statistics Tab -->
            <div class="tab-content {% if request.GET.tab != 'faculty' and request.GET.tab != 'publications' %}active{% endif %}" id="stats-tab">
                <div class="stats-section">
                    <div class="section-title-with-info">
                        <h2 class="section-title">Statistics Dashboard</h2>
                        <button class="info-icon-btn" id="scoring-info-btn" title="View calculation criteria">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Key Metrics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card gradient-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-value">{{ total_pubs }}</div>
                            <div class="stat-label">Total Publications</div>
                            <div class="stat-trend">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                    <polyline points="17 6 23 6 23 12"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-card gradient-card">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-value">{{ total_citations|floatformat:0 }}</div>
                            <div class="stat-label">Total Citations</div>
                            <div class="stat-trend">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                    <polyline points="17 6 23 6 23 12"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-card gradient-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-value">{{ avg_pubs_per_faculty }}</div>
                            <div class="stat-label">Avg. Publications per Faculty</div>
                            <div class="stat-sub-label">Per faculty member</div>
                        </div>
                        <div class="stat-card gradient-card">
                            <div class="stat-icon">‚≠ê</div>
                            <div class="stat-value">{{ avg_citations_per_faculty|floatformat:1 }}</div>
                            <div class="stat-label">Avg. Citations per Faculty</div>
                            <div class="stat-sub-label">Per faculty member</div>
                        </div>
                        <div class="stat-card gradient-card">
                            <div class="stat-icon">üéì</div>
                            <div class="stat-value">{{ num_faculty }}</div>
                            <div class="stat-label">Current Faculty Members</div>
                        </div>
                    </div>

                    <!-- Ranking Breakdown Table -->
                    <div class="ranking-stats">
                        <h3 class="subsection-title">Detailed Ranking Breakdown</h3>
                        <div class="ranking-grid">
                            {% for ranking_code, data in stats_by_ranking.items %}
                            {% if data.count > 0 %}
                            <div class="ranking-card">
                                <div class="ranking-label">{{ data.label }}</div>
                                <div class="ranking-value">{{ data.count }}</div>
                                <div class="ranking-score">Score: {{ data.score }}</div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-container">
                        <div class="chart-grid">
                            <!-- Publications by Ranking Chart -->
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3 class="chart-title">Publications by Ranking</h3>
                                    <div class="chart-legend" id="ranking-legend"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="rankingChart"></canvas>
                                </div>
                            </div>

                            <!-- Publications by Type Chart -->
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3 class="chart-title">Publications by Type</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="typeChart"></canvas>
                                </div>
                            </div>

                            <!-- Publications Over Time Chart -->
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3 class="chart-title">Publications Over Time</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="timeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Faculty Scores Tab -->
            <div class="tab-content {% if request.GET.tab == 'faculty' %}active{% endif %}" id="faculty-tab">
                <div class="faculty-scores-section">
                    <!-- Faculty Tabs -->
                    <div class="faculty-view-tabs">
                        <div class="faculty-tab-buttons">
                            <button class="faculty-tab-btn active" data-faculty-tab="all-faculties">
                                All Faculties
                                <button class="faculty-tab-info-btn" title="View all faculty members" onclick="event.stopPropagation(); openFacultyTabInfoModal('all-faculties')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </button>
                            </button>
                            <button class="faculty-tab-btn" data-faculty-tab="most-cited">
                                Most Cited
                                <button class="faculty-tab-info-btn" title="How are most cited researchers selected?" onclick="event.stopPropagation(); openFacultyTabInfoModal('most-cited')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </button>
                            </button>
                            <button class="faculty-tab-btn" data-faculty-tab="leading-active">
                                Leading Active
                                <button class="faculty-tab-info-btn" title="How are leading active researchers selected?" onclick="event.stopPropagation(); openFacultyTabInfoModal('leading-active')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </button>
                            </button>
                            <button class="faculty-tab-btn" data-faculty-tab="top-designation">
                                Top by Designation
                                <button class="faculty-tab-info-btn" title="How are top researchers by designation selected?" onclick="event.stopPropagation(); openFacultyTabInfoModal('top-designation')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </button>
                            </button>
                        </div>
                        
                        <!-- Tab 1: All Faculties -->
                        <div class="faculty-tab-content active" id="all-faculties-tab">
                            <div class="faculty-cards-grid">
                                {% for item in faculty_scores %}
                                <a href="{% url 'people:faculty_detail' item.faculty.pk %}" class="faculty-card-item">
                                    <div class="faculty-card {% if item.badges %}has-badges{% endif %}">
                                        <div class="faculty-card-image">
                                            {% if item.faculty.profile_pic %}
                                                <img src="/media/{{ item.faculty.profile_pic.name|cache_bust:item.faculty }}" alt="{{ item.faculty.name }}">
                                            {% else %}
                                                <div class="faculty-emoji-placeholder">üë§</div>
                                            {% endif %}
                                            {% if item.badges %}
                                            <div class="faculty-badges">
                                                {% if 'most_cited' in item.badges %}
<span class="faculty-badge badge-most-cited" title="Top 4 Most Cited">
  <i class="fa-solid fa-star"></i>
</span>
{% endif %}

{% if 'leading_active' in item.badges %}
<span class="faculty-badge badge-leading-active" title="Top 4 Leading Active">
  <i class="fa-solid fa-bolt"></i>
</span>
{% endif %}

                                                {% if 'top_designation' in item.badges %}
                                                <span class="faculty-badge badge-top-designation" title="Top by Designation">
                                                      <i class="fa-solid fa-trophy"></i>
                                                   </span>

                                                {% endif %}
                                            </div>
                                            {% endif %}
                                           <div class="faculty-card-overlay">
    <div class="faculty-card-info">

        <!-- First row: serial, score, citations -->
        <div class="faculty-card-header">
            <span class="faculty-card-sl">#{{ item.faculty.sl|default:"-" }}</span>
            <span class="faculty-card-score" title="Score: {{ item.score }}">
                üî• {{ item.score|default:"0" }}
            </span>
            <span class="faculty-card-citation" title="Citations: {{ item.citations|floatformat:0 }}">
                üìö {{ item.citations|floatformat:0 }}
            </span>
        </div>

        <!-- Second row: name -->
        <h3 class="faculty-card-name">{{ item.faculty.name }}</h3>

    </div>
</div>
                                        </div>
                                    </div>
                                </a>
                                {% empty %}
                                <p class="empty-message">No faculty found.</p>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Tab 2: Most Cited -->
                       <div class="faculty-tab-content" id="most-cited-tab">
    <div class="faculty-cards-grid">
        {% for item in all_faculty_most_cited %}
        <a href="{% url 'people:faculty_detail' item.faculty.pk %}" class="faculty-card-item">
            <div class="faculty-card">

                <div class="faculty-card-image">
                    {% if item.faculty.profile_pic %}
                        <img src="/media/{{ item.faculty.profile_pic.name|cache_bust:item.faculty }}" alt="{{ item.faculty.name }}">
                    {% else %}
                        <div class="faculty-emoji-placeholder">üë§</div>
                    {% endif %}

                    <div class="faculty-card-overlay">
                        <div class="faculty-card-info">

                            <!-- üîπ FIRST ROW: # üî• üìö -->
                            <div class="faculty-card-header">
                                <span class="faculty-card-sl">
                                    #{{ forloop.counter }}
                                </span>

                                <span class="faculty-card-score" title="Score: {{ item.score }}">
                                    üî• {{ item.score|default:"0" }}
                                </span>

                                <span class="faculty-card-citation" title="Citations: {{ item.citations|floatformat:0 }}">
                                    üìö {{ item.citations|floatformat:0 }}
                                </span>
                            </div>

                            <!-- üîπ SECOND ROW: NAME -->
                            <h3 class="faculty-card-name">
                                {{ item.faculty.name }}
                            </h3>

                        </div>
                    </div>
                </div>
            </div>
        </a>
                                {% empty %}
                                <p class="empty-message">No faculty found.</p>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Tab 3: Leading Active -->
                     <div class="faculty-tab-content" id="leading-active-tab">
    <div class="faculty-cards-grid">
        {% for item in all_faculty_leading_active %}
        <a href="{% url 'people:faculty_detail' item.faculty.pk %}" class="faculty-card-item">
            <div class="faculty-card {% if item.is_top_4 %}golden-rank{% endif %}">

                <div class="faculty-card-image">
                    {% if item.faculty.profile_pic %}
                        <img src="/media/{{ item.faculty.profile_pic.name|cache_bust:item.faculty }}" alt="{{ item.faculty.name }}">
                    {% else %}
                        <div class="faculty-emoji-placeholder">üë§</div>
                    {% endif %}

                    <div class="faculty-card-overlay">
                        <div class="faculty-card-info">

                            <!-- üîπ FIRST ROW: # üî• üìÑ -->
                            <div class="faculty-card-header">
                                <span class="faculty-card-sl">
                                    #{{ forloop.counter }}
                                </span>

                                <span class="faculty-card-score" title="Score: {{ item.score }}">
                                    üî• {{ item.score|default:"0" }}
                                </span>

                                <span class="faculty-card-pubs" title="Publications (Last 2 Years): {{ item.publication_count }}">
                                    üìë {{ item.publication_count }}
                                </span>
                            </div>

                            <!-- üîπ SECOND ROW: NAME -->
                            <h3 class="faculty-card-name">
                                {{ item.faculty.name }}
                            </h3>

                        </div>
                    </div>
                </div>
                 </div>

        </a>
                                {% empty %}
                                <p class="empty-message">No faculty found.</p>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Tab 4: Top by Designation -->
                  <div class="faculty-tab-content" id="top-designation-tab">
    <!-- Most Cited in Designation -->
    <div class="designation-section">
        <h3 class="designation-section-title">Most Cited in</h3>
        {% regroup all_faculty_most_cited_by_designation by designation as cited_by_designation %}

        {% for designation_group in cited_by_designation %}
        <div class="designation-group">
            <h4 class="designation-group-title">{{ designation_group.grouper }}</h4>

            <div class="faculty-cards-grid-designation">
                {% for item in designation_group.list %}
                <a href="{% url 'people:faculty_detail' item.faculty.pk %}" class="faculty-card-item">
                    <div class="faculty-card">

                        <!-- Image -->
                        <div class="faculty-card-image">
                            {% if item.faculty.profile_pic %}
                                <img src="/media/{{ item.faculty.profile_pic.name|cache_bust:item.faculty }}" alt="{{ item.faculty.name }}">
                            {% else %}
                                <div class="faculty-emoji-placeholder">üë§</div>
                            {% endif %}

                            <div class="faculty-card-overlay">
                                <div class="faculty-card-info">

                                    <!-- üîπ FIRST ROW: Rank, Score, Citations -->
                                    <div class="faculty-card-header">
                                        <span class="faculty-card-sl">
                                            #{{ forloop.counter }}
                                        </span>
                                        <span class="faculty-card-score" title="Score: {{ item.score }}">
                                            üî• {{ item.score|default:"0" }}
                                        </span>
                                        <span class="faculty-card-citation" title="Citations: {{ item.citations|floatformat:0 }}">
                                            üìö {{ item.citations|floatformat:0 }}
                                        </span>
                                    </div>

                                    <!-- üîπ SECOND ROW: Name -->
                                    <h3 class="faculty-card-name">
                                        {{ item.faculty.name }}
                                    </h3>

                                </div>
                            </div>
                        </div>

                        <!-- üîπ Designation -->
                        <div class="faculty-card-designation">
                            {{ item.designation }}
                        </div>

                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <p class="empty-message">No faculty found.</p>
        {% endfor %}
    </div>

            <!-- Publications Tab -->
            <div class="tab-content {% if request.GET.tab == 'publications' %}active{% endif %}" id="publications-tab">
                <div class="publications-section">
                    <h2 class="section-title">All Publications</h2>
                    <div class="publications-table-container">
                        <table class="publications-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Year</th>
                                    <th>Type</th>
                                    <th>Ranking</th>
                                    <th>Faculty</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pub in publications %}
                                <tr>
                                    <td class="title-cell">{{ pub.title }}</td>
                                    <td>{{ pub.pub_year }}</td>
                                    <td>
                                        <span class="type-badge type-{{ pub.type }}">
                                            {{ pub.get_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="ranking-badge ranking-{{ pub.ranking }}">
                                            {{ pub.get_ranking_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'people:faculty_detail' pub.faculty.pk %}" class="faculty-link">
                                            {{ pub.faculty.name }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if pub.link %}
                                        <a href="{{ pub.link }}" target="_blank" rel="noopener noreferrer" class="read-paper-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                                <polyline points="15 3 21 3 21 9"></polyline>
                                                <line x1="10" y1="14" x2="21" y2="3"></line>
                                            </svg>
                                            Read Paper
                                        </a>
                                        {% else %}
                                        <span class="no-link">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="empty-message">No publications found for the selected period.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
.designation-section {
    margin-bottom: 3rem;
}

.designation-section:last-child {
    margin-bottom: 0;
}

.designation-section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0 0 1.5rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--border-color);
}

.designation-group {
    margin-bottom: 2rem;
}

.designation-group:last-child {
    margin-bottom: 0;
}

.designation-group-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1rem 0;
    padding-left: 0.5rem;
    border-left: 3px solid var(--color-primary);
}

.faculty-cards-grid-designation {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (max-width: 1200px) {
    .faculty-cards-grid-designation {
        grid-template-columns: repeat(3, 1fr);
        gap: 1.25rem;
    }
}

@media (max-width: 900px) {
    .faculty-cards-grid-designation {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
}

@media (max-width: 600px) {
    .faculty-cards-grid-designation {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    .designation-group {
        margin-bottom: 2.5rem;
    }
    
    .designation-group-title {
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }
    
    .faculty-cards-grid-designation .faculty-card {
        min-height: clamp(110px, 15vw, 140px);
        border-radius: 8px;
    }
    
    .faculty-cards-grid-designation .faculty-card-image {
        max-height: 210px;
        aspect-ratio: 3 / 4;
    }
    
    .faculty-cards-grid-designation .faculty-card-name {
        font-size: 0.55rem;
        line-height: 1.1;
    }
    
    .faculty-cards-grid-designation .faculty-card-header {
        font-size: 0.45rem;
        gap: 0.25rem;
    }
    
    .faculty-cards-grid-designation .faculty-card-sl,
    .faculty-cards-grid-designation .faculty-card-score,
    .faculty-cards-grid-designation .faculty-card-citation {
        font-size: 0.425rem;
    }
    
    .faculty-cards-grid-designation .faculty-card-overlay {
        padding: 0.625rem 0.5rem 0.5rem 0.5rem;
    }
    
    .faculty-cards-grid-designation .faculty-card-designation {
        font-size: 0.375rem;
        padding: 0.25rem 0.375rem;
    }
    
    /* All Faculties, Most Cited and Leading Active tabs - mobile size reduction */
    #all-faculties-tab .faculty-cards-grid,
    #most-cited-tab .faculty-cards-grid,
    #leading-active-tab .faculty-cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    #all-faculties-tab .faculty-card,
    #most-cited-tab .faculty-card,
    #leading-active-tab .faculty-card {
        min-height: clamp(110px, 15vw, 140px);
        border-radius: 8px;
    }
    
    #all-faculties-tab .faculty-card-image,
    #most-cited-tab .faculty-card-image,
    #leading-active-tab .faculty-card-image {
        max-height: 210px;
        aspect-ratio: 3 / 4;
    }
    
    #all-faculties-tab .faculty-card-name,
    #most-cited-tab .faculty-card-name,
    #leading-active-tab .faculty-card-name {
        font-size: 0.55rem;
        line-height: 1.1;
    }
    
    #all-faculties-tab .faculty-card-header,
    #most-cited-tab .faculty-card-header,
    #leading-active-tab .faculty-card-header {
        font-size: 0.45rem;
        gap: 0.25rem;
    }
    
    #all-faculties-tab .faculty-card-sl,
    #all-faculties-tab .faculty-card-score,
    #all-faculties-tab .faculty-card-citation,
    #most-cited-tab .faculty-card-sl,
    #most-cited-tab .faculty-card-score,
    #most-cited-tab .faculty-card-citation,
    #leading-active-tab .faculty-card-sl,
    #leading-active-tab .faculty-card-score,
    #leading-active-tab .faculty-card-pubs {
        font-size: 0.425rem;
    }
    
    #all-faculties-tab .faculty-card-overlay,
    #most-cited-tab .faculty-card-overlay,
    #leading-active-tab .faculty-card-overlay {
        padding: 0.625rem 0.5rem 0.5rem 0.5rem;
    }
    
    #all-faculties-tab .faculty-badge {
        width: 1.5rem;
        height: 1.5rem;
        font-size: 0.75rem;
    }
    
    #all-faculties-tab .faculty-badge i {
        font-size: 0.7rem;
    }
    
    /* Hide "Top 4" text on mobile */
    #leading-active-tab .top-item {
        display: none;
    }
}

.research-page-section {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.research-header {
    margin-bottom: 2rem;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-text h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
    margin: 0;
}

.back-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
}

.back-link:hover {
    border-color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 5%, transparent);
}

/* Comprehensive Filter Bar */
.comprehensive-filter-bar {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.filter-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.filter-select {
    padding: 0.625rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-select:hover {
    border-color: var(--color-primary);
}

.filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.custom-year-range {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: 8px;
}

.custom-year-range.hidden {
    display: none;
}

.year-input {
    padding: 0.5rem;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-primary);
    color: var(--text-primary);
    width: 100px;
    font-size: 0.9rem;
}

.apply-btn {
    padding: 0.5rem 1rem;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s ease;
}

.apply-btn:hover {
    background: var(--color-primary-hover);
}

/* Period Filter Bar (legacy, keeping for compatibility) */
.period-filter-bar {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-label {
    font-weight: 600;
    color: var(--text-primary);
}

.filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.95rem;
}

.filter-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.filter-btn.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

/* Statistics Section */
.stats-section {
    margin-bottom: 3rem;
}

.section-title-with-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 2rem;
}

.section-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.info-icon-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    border: 1px solid var(--border-color);
    border-radius: 50%;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.info-icon-btn:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
    transform: scale(1.1);
}

.info-icon-btn svg {
    width: 18px;
    height: 18px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.subsection-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 2rem 0 1rem 0;
}

.ranking-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
}

.ranking-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
}

.ranking-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.ranking-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 0.25rem;
}

.ranking-score {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Faculty Scores Section */
.faculty-scores-section {
    margin-bottom: 3rem;
}

.scores-table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.scores-table {
    width: 100%;
    border-collapse: collapse;
}

.scores-table thead {
    background: var(--bg-tertiary);
}

.scores-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
}

.scores-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.scores-table tbody tr:hover {
    background: color-mix(in srgb, var(--color-primary) 3%, transparent);
}

.rank-cell {
    font-weight: 600;
    color: var(--text-secondary);
}

.top-rank {
    color: var(--color-primary);
    font-size: 1.1rem;
}

.faculty-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
}

.faculty-link:hover {
    text-decoration: underline;
}

.score-cell {
    font-weight: 700;
    color: var(--color-primary);
    font-size: 1.1rem;
}

/* Publications Section */
.publications-section {
    margin-bottom: 3rem;
}

.publications-table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow-x: auto;
}

.publications-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.publications-table thead {
    background: var(--bg-tertiary);
}

.publications-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
    white-space: nowrap;
}

.publications-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.publications-table tbody tr:hover {
    background: color-mix(in srgb, var(--color-primary) 3%, transparent);
}

.title-cell {
    max-width: 400px;
    word-wrap: break-word;
}

.type-badge,
.ranking-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.type-journal {
    background: color-mix(in srgb, #3b82f6 15%, transparent);
    color: #3b82f6;
    border: 1px solid color-mix(in srgb, #3b82f6 30%, transparent);
}

.type-conf {
    background: color-mix(in srgb, #10b981 15%, transparent);
    color: #10b981;
    border: 1px solid color-mix(in srgb, #10b981 30%, transparent);
}

.type-bookchapter {
    background: color-mix(in srgb, #8b5cf6 15%, transparent);
    color: #8b5cf6;
    border: 1px solid color-mix(in srgb, #8b5cf6 30%, transparent);
}

.type-other {
    background: color-mix(in srgb, #6b7280 15%, transparent);
    color: #6b7280;
    border: 1px solid color-mix(in srgb, #6b7280 30%, transparent);
}

.ranking-q1 {
    background: color-mix(in srgb, #10b981 15%, transparent);
    color: #10b981;
    border: 1px solid color-mix(in srgb, #10b981 30%, transparent);
}

.ranking-q2 {
    background: color-mix(in srgb, #3b82f6 15%, transparent);
    color: #3b82f6;
    border: 1px solid color-mix(in srgb, #3b82f6 30%, transparent);
}

.ranking-q3 {
    background: color-mix(in srgb, #f59e0b 15%, transparent);
    color: #f59e0b;
    border: 1px solid color-mix(in srgb, #f59e0b 30%, transparent);
}

.ranking-q4 {
    background: color-mix(in srgb, #ef4444 15%, transparent);
    color: #ef4444;
    border: 1px solid color-mix(in srgb, #ef4444 30%, transparent);
}

.ranking-a_star,
.ranking-a,
.ranking-b,
.ranking-c {
    background: color-mix(in srgb, #8b5cf6 15%, transparent);
    color: #8b5cf6;
    border: 1px solid color-mix(in srgb, #8b5cf6 30%, transparent);
}

.ranking-not_indexed {
    background: color-mix(in srgb, #6b7280 15%, transparent);
    color: #6b7280;
    border: 1px solid color-mix(in srgb, #6b7280 30%, transparent);
}

.read-paper-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: var(--color-primary);
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.read-paper-btn:hover {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px color-mix(in srgb, var(--color-primary) 30%, transparent);
}

.no-link {
    color: var(--text-secondary);
    font-style: italic;
}

.empty-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-style: italic;
}

/* Faculty View Tabs */
.faculty-view-tabs {
    margin-top: 2rem;
}

/* Charts Container */
.charts-container {
    margin: 2rem 0;
}

.chart-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.chart-card:hover {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}


.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.chart-wrapper {
    position: relative;
    height: 300px;
    width: 100%;
}


.stat-card.gradient-card {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.stat-card.gradient-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-color: var(--color-primary);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
}

.stat-trend {
    position: absolute;
    top: 1rem;
    right: 1rem;
    color: var(--color-primary);
    opacity: 0.6;
}

.stat-sub-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.faculty-tab-buttons {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--border-color);
    flex-wrap: wrap;
}

.faculty-tab-btn {
    padding: 0.875rem 1.75rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: -2px;
    position: relative;
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.faculty-tab-info-btn {
    background: transparent;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-secondary);
    padding: 0;
    flex-shrink: 0;
}

.faculty-tab-info-btn svg {
    width: 14px;
    height: 14px;
}

.faculty-tab-info-btn:hover {
    background: color-mix(in srgb, var(--color-primary) 10%, transparent);
    color: var(--color-primary);
    transform: scale(1.1);
}

.faculty-tab-btn.active .faculty-tab-info-btn {
    color: var(--color-primary);
}

.faculty-tab-btn:hover {
    color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 5%, transparent);
}

.faculty-tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    font-weight: 600;
    background: color-mix(in srgb, var(--color-primary) 3%, transparent);
}

.faculty-tab-content {
    display: none;
}

.faculty-tab-content.active {
    display: block;
    animation: fadeInSlide 0.4s ease;
}

@keyframes fadeInSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Faculty Cards Grid - 4 per row */
.faculty-cards-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    margin-top: 1rem;
}

@media (max-width: 1200px) {
    .faculty-cards-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 900px) {
    .faculty-cards-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.faculty-card-item{
    text-decoration: none;
    color: inherit;
    display: block;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: center bottom;
    transform-style: preserve-3d;
    will-change: transform;
    position: relative;
    overflow: visible;
    perspective: 1200px;
    perspective-origin: 50% 100%;
}

.faculty-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 0;

    display: flex;
    flex-direction: column;

    position: relative;
    overflow: hidden;
    cursor: pointer;

    height: 100%;
    min-height: clamp(220px, 30vw, 280px);

    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);

    transition:
        transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
        box-shadow 0.4s ease;

    transform-style: preserve-3d;
    transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
}
@media (max-width: 768px) {
    .faculty-card {
        min-height: unset;
        border-radius: 14px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    }
}

/* Apple-like hover: scale up and tilt the card backward (leaning back) - straight, no side rotation */
.faculty-card-item:hover {
    transform: scale(1.08) translateY(-8px) rotateX(12deg) rotateY(0deg) rotateZ(0deg);
    z-index: 100;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.faculty-card-item:hover .faculty-card {
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    border-color: var(--color-primary);
    border-width: 2px;
}
.faculty-card-image {
    width: 100%;
    aspect-ratio: 3 / 4; /* portrait look ‚Äì adjust if needed */
    max-height: 420px;
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.faculty-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}


.faculty-card-item:hover .faculty-card-image img {
    transform: scale(1.05);
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.faculty-emoji-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border-radius: 12px;
}

/* Only apply blur when hovering directly on a card, not on empty space */
.faculty-cards-grid:has(.faculty-card-item:hover) .faculty-card-item:not(:hover) {
    transform: scale(0.92);
    opacity: 0.6;
    filter: blur(2px);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
.faculty-badges {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    z-index: 10;
}

.faculty-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    font-size: 1rem;
    color: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

.faculty-card-item:hover .faculty-badge {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}
.badge-most-cited i {
  color: #f4c430; /* gold */
}

.badge-leading-active i {
  color: #ff5a3c; /* energetic */
}
.golden-rank-badge-below {
    background: transparent;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 700;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: absolute;
    bottom: 0.5rem;
    left: 0;
    right: 0;
    z-index: 4;
    pointer-events: none;

    /* Gradient text using theme colors */
    background: linear-gradient(
        90deg,
        var(--color-primary),
        color-mix(in srgb, var(--color-primary) 70%, white 30%),
        color-mix(in srgb, var(--color-primary) 50%, white 50%)
    );
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;

    /* Subtle shadow */
    text-shadow: 0 2px 4px rgba(0,0,0,0.3),
                 0 0 6px color-mix(in srgb, var(--color-primary) 60%, transparent);

    /* Animation */
    animation: gradientSlide 4s ease-in-out infinite, badgePulse 3s ease-in-out infinite alternate;
}

@keyframes gradientSlide {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

@keyframes badgePulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.faculty-card-designation {
    color: var(--text-secondary);
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    border-top: 1px solid var(--border-color);
}

.top-item{
    color: var(--text-secondary);
    background: transparent;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 700;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: absolute;
    bottom: 0.5rem;
    left: 0;
    right: 0;
    z-index: 4;
    pointer-events: none;

    /* Gradient text using theme colors */
    background: linear-gradient(
        90deg,
        var(--color-primary),
        color-mix(in srgb, var(--color-primary) 70%, white 30%),
        color-mix(in srgb, var(--color-primary) 50%, white 50%)
    );
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;

    /* Subtle shadow */
    text-shadow: 0 2px 4px rgba(0,0,0,0.3),
                 0 0 6px color-mix(in srgb, var(--color-primary) 60%, transparent);

    /* Animation */
    animation: gradientSlide 4s ease-in-out infinite, badgePulse 3s ease-in-out infinite alternate;
}


.faculty-card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.7) 50%, rgba(0, 0, 0, 0) 100%);
    padding: 1.25rem 1rem 1rem 1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.faculty-card-item:hover .faculty-card-overlay {
    padding: 1.5rem 1.25rem 1.25rem 1.25rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.75) 50%, rgba(0, 0, 0, 0) 100%);
}


.faculty-card-info {
    display: flex;
    flex-direction: column; /* stack rows vertically */
    gap: 0.25rem;           /* spacing between rows */
}

/* First row: serial, score, citations */
.faculty-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;            /* space between #, üî•, üìö */
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
}

/* Name row styling */
.faculty-card-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    line-height: 1.2;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}
@media (max-width: 768px) {
    .faculty-card-name {
        display: block;              /* üîë REQUIRED */
        max-height: 3rem;            /* force overflow */

        white-space: normal;
        word-break: break-word;

        overflow-y: auto;
        overflow-x: hidden;

        -webkit-overflow-scrolling: touch;
        /* Hide scrollbar */
        scrollbar-width: none;
    }

    .faculty-card-name::-webkit-scrollbar {
        display: none;
    }
        .faculty-card-name h3{
    margin-top:0;!important;
    margin-bottom:0;!important;
}
}


.faculty-badge i {
  font-size: 0.9rem;
  color: gold;
}


.faculty-card-sl {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(0, 0, 0, 0.3);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    flex-shrink: 0;
}
.faculty-card-meta {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.faculty-card-score,
.faculty-card-citation,
.faculty-card-pubs {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* Top Researchers Cards */
.researcher-section {
    margin-bottom: 3rem;
}

.researcher-section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0 0 1.5rem 0;
    text-align: center;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--border-color);
}

.top-researchers-list {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.designation-title-small {
    font-size: 1rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0.75rem 0 0 0;
    text-align: center;
    padding: 0;
    border: none;
}

.top-researcher-item {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: center bottom;
    transform-style: preserve-3d;
    will-change: transform;
    position: relative;
    overflow: visible;
    perspective: 1200px;
    perspective-origin: 50% 100%;
}

.top-researcher-item:hover {
    transform: scale(1.08) translateY(-8px) rotateX(12deg) rotateY(0deg) rotateZ(0deg);
    z-index: 100;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.researcher-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    height: 100%;
    min-height: 280px;
    width: 200px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-style: preserve-3d;
    transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
}

.top-researcher-item:hover .researcher-card {
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    border-color: var(--color-primary);
    border-width: 2px;
}

.researcher-card-image {
    width: 100%;
    height: 100%;
    min-height: 280px;
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.researcher-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.top-researcher-item:hover .researcher-card-image img {
    transform: scale(1.05);
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.researcher-card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.7) 50%, rgba(0, 0, 0, 0) 100%);
    padding: 1.25rem 1rem 1rem 1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.top-researcher-item:hover .researcher-card-overlay {
    padding: 1.5rem 1.25rem 1.25rem 1.25rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.75) 50%, rgba(0, 0, 0, 0) 100%);
}

.researcher-card-info {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    position: relative;
}

.researcher-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: white;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.top-researcher-item:hover .researcher-name {
    font-size: 1.2rem;
}

.researcher-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin: 0;
}

.researcher-score,
.researcher-citation,
.researcher-pubs {
    font-size: 0.85rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.researcher-score,
.researcher-citation,
.researcher-pubs {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    font-weight: 500;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.top-researcher-item:hover .researcher-score,
.top-researcher-item:hover .researcher-citation,
.top-researcher-item:hover .researcher-pubs {
    font-size: 0.85rem;
}

/* Section Header with Info Button */
.section-header-with-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    gap: 1rem;
}

.info-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
}

.info-btn:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
    transform: scale(1.1);
}

.info-btn svg {
    width: 20px;
    height: 20px;
}

/* Info Modal */
.info-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.info-modal.active {
    display: flex;
}

.info-modal-content {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 2rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    position: relative;
}

.info-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.info-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.info-modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.info-modal-close svg {
    width: 24px;
    height: 24px;
}

.scoring-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.scoring-table th,
.scoring-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.scoring-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
}

.scoring-table td {
    color: var(--text-secondary);
}

.scoring-table tr:last-child td {
    border-bottom: none;
}

.scoring-explanation {
    margin-top: 1.5rem;
    padding: 1rem;
    background: color-mix(in srgb, var(--color-primary) 8%, transparent);
    border-radius: 10px;
}

/* Faculty Tab Info Modal Styles */
.info-modal-home {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.info-modal-home.active {
    display: flex;
}

.info-modal-content-home {
    background: var(--bg-primary);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
}

.info-modal-header-home {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 2px solid var(--border-color);
}

.info-modal-header-home h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
}

.info-modal-close-home {
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-modal-close-home:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.info-modal-body-home {
    padding: 1.5rem;
    color: var(--text-primary);
    line-height: 1.6;
}

.info-modal-body-home p {
    margin: 0 0 1rem 0;
}

.info-modal-body-home ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
}

.info-modal-body-home li {
    margin-bottom: 0.5rem;
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
    border-left: 4px solid var(--color-primary);
}

.scoring-explanation p {
    margin: 0;
    color: var(--text-primary);
    line-height: 1.6;
}

/* Tabs */
.tabs-container {
    margin-bottom: 2rem;
}

.tabs-nav {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Lexend', sans-serif;
    margin-bottom: -2px;
}

.tab-btn:hover {
    color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 5%, transparent);
}

.tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 8%, transparent);
}

.tab-btn svg {
    width: 18px;
    height: 18px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .ranking-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .chart-grid {
        grid-template-columns: 1fr;
    }

    .publications-table-container {
        overflow-x: auto;
    }

    .faculty-cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
    }

    .faculty-tab-buttons {
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        justify-content: flex-start;
        padding-left: 0;
        padding-right: 0;
    }

    .faculty-tab-buttons::-webkit-scrollbar {
        height: 4px;
    }

    .faculty-tab-buttons::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
    }

    .faculty-tab-buttons::-webkit-scrollbar-thumb {
        background: var(--color-primary);
        border-radius: 2px;
    }

    .faculty-tab-btn {
        white-space: nowrap;
        flex-shrink: 0;
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
    }

    .faculty-card-name {
        font-size: 1rem;
    }

    .faculty-card-score,
    .faculty-card-citation,
    .faculty-card-pubs {
        font-size: 0.8rem;
    }

    .golden-rank-badge {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
    }

    .faculty-badge {
        width: 1.75rem;
        height: 1.75rem;
        font-size: 0.9rem;
    }

    .tabs-nav {
        flex-direction: column;
        gap: 0;
    }

    .tab-btn {
        width: 100%;
        justify-content: flex-start;
        border-bottom: 1px solid var(--border-color);
        border-left: 3px solid transparent;
        margin-bottom: 0;
    }

    .tab-btn.active {
        border-left-color: var(--color-primary);
        border-bottom-color: var(--border-color);
    }

    .top-researchers-list {
        gap: 1rem;
    }

    .researcher-section {
        margin-bottom: 2rem;
    }

    .researcher-section-title {
        font-size: 1.25rem;
    }

    .researcher-card {
        width: 100%;
        max-width: 300px;
    }

    .chart-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1024px) {
    .chart-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 600px) {
    .chart-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Chart.js -->
<script>
// Load Chart.js with fallback support
(function() {
    function loadChartJS() {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
        script.async = true;
        script.onload = function() {
            console.log('Chart.js loaded successfully');
            // Trigger chart initialization if DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    if (typeof Chart !== 'undefined') {
                        {% if request.GET.tab != 'faculty' and request.GET.tab != 'publications' or not request.GET.tab %}
                        waitForChartJS(function() {
                            initializeCharts();
                        });
                        {% endif %}
                    }
                });
            } else {
                {% if request.GET.tab != 'faculty' and request.GET.tab != 'publications' or not request.GET.tab %}
                waitForChartJS(function() {
                    initializeCharts();
                });
                {% endif %}
            }
        };
        script.onerror = function() {
            console.error('Failed to load Chart.js from jsdelivr CDN, trying fallback...');
            loadChartJSFallback();
        };
        document.head.appendChild(script);
    }
    
    // Start loading Chart.js
    loadChartJS();
})();
</script>

<script>
// Fallback function to load Chart.js if CDN fails
function loadChartJSFallback() {
    console.log('Attempting to load Chart.js from alternative CDN...');
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js';
    script.async = true;
    script.onload = function() {
        console.log('Chart.js loaded from fallback CDN');
        // Retry chart initialization after fallback loads
        waitForChartJS(function() {
            initializeCharts();
        });
    };
    script.onerror = function() {
        console.error('Failed to load Chart.js from fallback CDN as well');
    };
    document.head.appendChild(script);
}

// Wait for Chart.js to be available before initializing
function waitForChartJS(callback, maxAttempts = 50) {
    let attempts = 0;
    const checkInterval = setInterval(function() {
        attempts++;
        if (typeof Chart !== 'undefined') {
            clearInterval(checkInterval);
            callback();
        } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            console.error('Chart.js failed to load after ' + maxAttempts + ' attempts');
            loadChartJSFallback();
        }
    }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
    // Charts are initialized automatically when Chart.js loads
    // This is handled in the Chart.js loading script above
    
    // Get current tab from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentTab = urlParams.get('tab') || 'stats';
    
    // Get filter form and tab input
    const filterForm = document.getElementById('filter-form');
    const tabInput = document.getElementById('current-tab-input');
    
    // Ensure tab input is set to current tab
    if (tabInput) {
        tabInput.value = currentTab;
    }
    
    // Function to get current active tab
    function getCurrentActiveTab() {
        const activeTabButton = document.querySelector('.tab-btn.active');
        if (activeTabButton) {
            return activeTabButton.dataset.tab || 'stats';
        }
        return currentTab;
    }
    
    // Ensure form submission preserves current tab
    if (filterForm) {
        filterForm.addEventListener('submit', function() {
            if (tabInput) {
                tabInput.value = getCurrentActiveTab();
            }
        });
    }
    
    // Update tab input when select elements change and submit form
    const filterSelects = document.querySelectorAll('.filter-select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            if (tabInput) {
                tabInput.value = getCurrentActiveTab();
            }
            if (filterForm) {
                filterForm.submit();
            }
        });
    });
    
    // Custom year range toggle
    const customPeriodBtn = document.getElementById('custom-period-btn');
    const customYearRange = document.getElementById('custom-year-range');
    if (customPeriodBtn && customYearRange) {
        customPeriodBtn.addEventListener('click', function(e) {
            if (!customYearRange.classList.contains('hidden')) {
                e.preventDefault();
                customYearRange.classList.toggle('hidden');
            } else {
                // When clicking custom, show the year range inputs
                customYearRange.classList.remove('hidden');
            }
        });
    }
    
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Function to update URL with tab parameter
    function updateTabInURL(tab) {
        const url = new URL(window.location);
        url.searchParams.set('tab', tab);
        // Preserve period parameter if it exists
        const period = url.searchParams.get('period') || 'all_time';
        window.history.pushState({}, '', `?period=${period}&tab=${tab}`);
    }
    
    
    // Function to switch tabs
    function switchTab(targetTab) {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked button and corresponding content
        const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
        const activeContent = document.getElementById(targetTab + '-tab');
        
        if (activeButton) activeButton.classList.add('active');
        if (activeContent) activeContent.classList.add('active');
        
        // Update URL and localStorage
        updateTabInURL(targetTab);
        localStorage.setItem('research_page_tab', targetTab);
        
        // Update hidden input in filter form
        if (tabInput) {
            tabInput.value = targetTab;
        }
    }
    
    // Initialize tab from URL or localStorage
    const urlTab = urlParams.get('tab');
    const storedTab = localStorage.getItem('research_page_tab');
    const initialTab = urlTab || storedTab || 'stats';
    
    if (initialTab !== 'stats') {
        switchTab(initialTab);
    } else {
        // Ensure tab input is set for stats tab
        if (tabInput) {
            tabInput.value = 'stats';
        }
    }
    
    // Ensure period filter buttons preserve current tab
    const periodFilterButtons = document.querySelectorAll('.filter-btn[type="submit"]');
    periodFilterButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (tabInput) {
                tabInput.value = getCurrentActiveTab();
            }
        });
    });
    
    // Ensure Apply button for custom year range preserves current tab
    const applyYearRangeBtn = document.getElementById('apply-year-range-btn');
    if (applyYearRangeBtn) {
        applyYearRangeBtn.addEventListener('click', function() {
            if (tabInput) {
                tabInput.value = getCurrentActiveTab();
            }
        });
    }
    
    // Handle tab button clicks
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            switchTab(targetTab);
        });
    });
    
    // Faculty view tabs (All Faculties, Most Cited, Leading Active)
    const facultyTabButtons = document.querySelectorAll('.faculty-tab-btn');
    const facultyTabContents = document.querySelectorAll('.faculty-tab-content');
    const facultyTabButtonsContainer = document.querySelector('.faculty-tab-buttons');
    
    // Function to scroll active tab into view on mobile
    function scrollActiveFacultyTabIntoView() {
        const activeButton = document.querySelector('.faculty-tab-btn.active');
        if (activeButton && facultyTabButtonsContainer) {
            // Check if we're on mobile (viewport width <= 768px)
            if (window.innerWidth <= 768) {
                activeButton.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'start'
                });
            }
        }
    }
    
    // Scroll active tab into view on page load
    setTimeout(scrollActiveFacultyTabIntoView, 100);
    
    // Also scroll on window resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(scrollActiveFacultyTabIntoView, 150);
    });
    
    facultyTabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Don't switch tabs if clicking the info button
            if (e.target.closest('.faculty-tab-info-btn')) {
                return;
            }
            const targetTab = this.getAttribute('data-faculty-tab');
            
            // Remove active class from all buttons and contents
            facultyTabButtons.forEach(btn => btn.classList.remove('active'));
            facultyTabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab + '-tab');
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Scroll the clicked button into view on mobile
            setTimeout(() => {
                if (window.innerWidth <= 768) {
                    this.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',
                        inline: 'center'
                    });
                }
            }, 50);
        });
    });
    
    // Info modal functionality
    const infoBtn = document.getElementById('scoring-info-btn');
    const infoModal = document.getElementById('scoring-info-modal');
    const closeModal = document.getElementById('close-info-modal');
    
    if (infoBtn && infoModal) {
        infoBtn.addEventListener('click', function() {
            infoModal.classList.add('active');
        });
    }
    
    if (closeModal && infoModal) {
        closeModal.addEventListener('click', function() {
            infoModal.classList.remove('active');
        });
    }
    
    // Close modal when clicking outside
    if (infoModal) {
        infoModal.addEventListener('click', function(e) {
            if (e.target === infoModal) {
                infoModal.classList.remove('active');
            }
        });
    }
    
    // Faculty Tab Info Modal Functions
    function openFacultyTabInfoModal(tabName) {
        const modal = document.getElementById('faculty-' + tabName + '-info-modal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closeFacultyTabInfoModal(tabName) {
        const modal = document.getElementById('faculty-' + tabName + '-info-modal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    // Make functions global
    window.openFacultyTabInfoModal = openFacultyTabInfoModal;
    window.closeFacultyTabInfoModal = closeFacultyTabInfoModal;
    
    // Close faculty tab info modals on background click
    document.addEventListener('click', function(e) {
        const modals = ['faculty-all-faculties-info-modal', 'faculty-most-cited-info-modal', 'faculty-leading-active-info-modal', 'faculty-top-designation-info-modal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && e.target === modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });
    
    // Close faculty tab info modals on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modals = ['faculty-all-faculties-info-modal', 'faculty-most-cited-info-modal', 'faculty-leading-active-info-modal', 'faculty-top-designation-info-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
});

// Chart Initialization
function initializeCharts() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded - attempting fallback');
        loadChartJSFallback();
        return;
    }
    
    console.log('Initializing charts...');
    
    // Ranking Chart (Bar Chart)
    const rankingCtx = document.getElementById('rankingChart');
    if (rankingCtx) {
        // Color mapping for rankings
        const rankingColors = {
            'q1': { bg: 'rgba(16, 185, 129, 0.8)', border: 'rgb(16, 185, 129)' },      // Q1 - green
            'q2': { bg: 'rgba(59, 130, 246, 0.8)', border: 'rgb(59, 130, 246)' },      // Q2 - blue
            'q3': { bg: 'rgba(245, 158, 11, 0.8)', border: 'rgb(245, 158, 11)' },      // Q3 - amber
            'q4': { bg: 'rgba(239, 68, 68, 0.8)', border: 'rgb(239, 68, 68)' },        // Q4 - red
            'a_star': { bg: 'rgba(139, 92, 246, 0.8)', border: 'rgb(139, 92, 246)' },  // A* - purple
            'a': { bg: 'rgba(139, 92, 246, 0.6)', border: 'rgb(139, 92, 246)' },      // A - purple lighter
            'b': { bg: 'rgba(139, 92, 246, 0.4)', border: 'rgb(139, 92, 246)' },      // B - purple even lighter
            'c': { bg: 'rgba(139, 92, 246, 0.2)', border: 'rgb(139, 92, 246)' },      // C - purple lightest
            'wos_scopus_indexed': { bg: 'rgba(107, 114, 128, 0.8)', border: 'rgb(107, 114, 128)' }, // WOS/Scopus - gray
            'not_indexed': { bg: 'rgba(107, 114, 128, 0.6)', border: 'rgb(107, 114, 128)' }, // Not Indexed - gray lighter
        };
        
        // Build data arrays, filtering out zero values
        const labels = [];
        const data = [];
        const backgroundColor = [];
        const borderColor = [];
        
        {% for ranking_code, data_item in stats_by_ranking.items %}
        {% if data_item.count > 0 %}
        labels.push('{{ data_item.label }}');
        data.push({{ data_item.count }});
        const rankingCode = '{{ ranking_code }}';
        if (rankingColors[rankingCode]) {
            backgroundColor.push(rankingColors[rankingCode].bg);
            borderColor.push(rankingColors[rankingCode].border);
        } else {
            backgroundColor.push('rgba(107, 114, 128, 0.8)');
            borderColor.push('rgb(107, 114, 128)');
        }
        {% endif %}
        {% endfor %}
        
        const rankingData = {
            labels: labels,
            datasets: [{
                label: 'Publications',
                data: data,
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 2
            }]
        };
        
        new Chart(rankingCtx, {
            type: 'bar',
            data: rankingData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    // Type Chart (Pie Chart)
    const typeCtx = document.getElementById('typeChart');
    if (typeCtx) {
        const typeData = {
            labels: [
                {% for type_code, data in stats_by_type.items %}
                '{{ data.label }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for type_code, data in stats_by_type.items %}
                    {{ data.count }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',   // Journal - blue
                    'rgba(16, 185, 129, 0.8)',   // Conference - green
                    'rgba(139, 92, 246, 0.8)',   // Book Chapter - purple
                    'rgba(107, 114, 128, 0.8)',  // Other - gray
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(16, 185, 129)',
                    'rgb(139, 92, 246)',
                    'rgb(107, 114, 128)',
                ],
                borderWidth: 2
            }]
        };
        
        new Chart(typeCtx, {
            type: 'pie',
            data: typeData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                }
            }
        });
    }
    
    // Time Chart (Line Chart)
    const timeCtx = document.getElementById('timeChart');
    if (timeCtx) {
        const timeData = {
            labels: [
                {% for item in publications_by_year %}
                '{{ item.year }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Publications',
                data: [
                    {% for item in publications_by_year %}
                    {{ item.count }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgb(99, 102, 241)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        };
        
        new Chart(timeCtx, {
            type: 'line',
            data: timeData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
}
</script>

<!-- Info Modal -->
<div class="info-modal" id="scoring-info-modal">
    <div class="info-modal-content">
        <div class="info-modal-header">
            <h3 class="info-modal-title">Research Score Calculation</h3>
            <button class="info-modal-close" id="close-info-modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="info-modal-body">
            <p>The research score is calculated based on the ranking of each publication:</p>
            <table class="scoring-table">
                <thead>
                    <tr>
                        <th>Ranking</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Q1</td>
                        <td>{{ scoring_system.q1 }} points</td>
                    </tr>
                    <tr>
                        <td>Q2</td>
                        <td>{{ scoring_system.q2 }} points</td>
                    </tr>
                    <tr>
                        <td>Q3</td>
                        <td>{{ scoring_system.q3 }} points</td>
                    </tr>
                    <tr>
                        <td>Q4</td>
                        <td>{{ scoring_system.q4 }} points</td>
                    </tr>
                    <tr>
                        <td>A*</td>
                        <td>{{ scoring_system.a_star }} points</td>
                    </tr>
                    <tr>
                        <td>A</td>
                        <td>{{ scoring_system.a }} points</td>
                    </tr>
                    <tr>
                        <td>B</td>
                        <td>{{ scoring_system.b }} points</td>
                    </tr>
                    <tr>
                        <td>C</td>
                        <td>{{ scoring_system.c }} points</td>
                    </tr>
                    <tr>
                        <td>WOS/Scopus Indexed</td>
                        <td>{{ scoring_system.wos_scopus_indexed }} points</td>
                    </tr>
                    <tr>
                        <td>Not Indexed</td>
                        <td>{{ scoring_system.not_indexed }} point</td>
                    </tr>
                </tbody>
            </table>
            <div class="scoring-explanation">
                <p><strong>How it works:</strong> Each faculty member's total research score is the sum of points from all their publications within the selected time period. Higher-ranked publications contribute more points to the overall score.</p>
            </div>
        </div>
    </div>
</div>

<!-- Faculty Tab Info Modals -->
<div class="info-modal-home" id="faculty-all-faculties-info-modal">
    <div class="info-modal-content-home">
        <div class="info-modal-header-home">
            <h3>All Faculties</h3>
            <button class="info-modal-close-home" onclick="closeFacultyTabInfoModal('all-faculties')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="info-modal-body-home">
            <p>This view displays all current faculty members with their research scores and citation counts. Faculty members who rank in the top 4 of any category (Most Cited, Leading Active, or Top by Designation) are marked with badges.</p>
        </div>
    </div>
</div>

<div class="info-modal-home" id="faculty-most-cited-info-modal">
    <div class="info-modal-content-home">
        <div class="info-modal-header-home">
            <h3>Most Cited Researchers (All Time)</h3>
            <button class="info-modal-close-home" onclick="closeFacultyTabInfoModal('most-cited')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="info-modal-body-home">
            <p>This section displays all faculty members sorted by their total citation count across all their publications, from all time. The top 4 researchers are highlighted with a golden badge.</p>
        </div>
    </div>
</div>

<div class="info-modal-home" id="faculty-leading-active-info-modal">
    <div class="info-modal-content-home">
        <div class="info-modal-header-home">
            <h3>Leading Active Researchers (Past 2yr)</h3>
            <button class="info-modal-close-home" onclick="closeFacultyTabInfoModal('leading-active')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="info-modal-body-home">
            <p>This section identifies the most active researchers based on their research score from publications released in the last two years. The score is calculated as follows:</p>
            <ul>
                <li><strong>Q1 publications:</strong> 10 points each</li>
                <li><strong>Q2 publications:</strong> 7 points each</li>
                <li><strong>Q3 publications:</strong> 5 points each</li>
                <li><strong>Q4 publications:</strong> 3 points each</li>
                <li><strong>A* publications:</strong> 8 points each</li>
                <li><strong>A publications:</strong> 6 points each</li>
                <li><strong>B publications:</strong> 4 points each</li>
                <li><strong>C publications:</strong> 2 points each</li>
                <li><strong>WOS/Scopus Indexed:</strong> 2 points each</li>
                <li><strong>Not Indexed:</strong> 1 point each</li>
            </ul>
            <p>The top 4 researchers are highlighted with a golden badge.</p>
        </div>
    </div>
</div>

<div class="info-modal-home" id="faculty-top-designation-info-modal">
    <div class="info-modal-content-home">
        <div class="info-modal-header-home">
            <h3>Top Researchers (Designation Wise)</h3>
            <button class="info-modal-close-home" onclick="closeFacultyTabInfoModal('top-designation')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="info-modal-body-home">
            <p>This section showcases researchers grouped by their academic designation (Professor, Associate Professor, Assistant Professor, Lecturer). The top researcher from each designation is highlighted with a golden badge.</p>
            <p>The selection is based on their overall research score, calculated from all their publications:</p>
            <ul>
                <li><strong>Q1 publications:</strong> 10 points each</li>
                <li><strong>Q2 publications:</strong> 7 points each</li>
                <li><strong>Q3 publications:</strong> 5 points each</li>
                <li><strong>Q4 publications:</strong> 3 points each</li>
                <li><strong>A* publications:</strong> 8 points each</li>
                <li><strong>A publications:</strong> 6 points each</li>
                <li><strong>B publications:</strong> 4 points each</li>
                <li><strong>C publications:</strong> 2 points each</li>
                <li><strong>WOS/Scopus Indexed:</strong> 2 points each</li>
                <li><strong>Not Indexed:</strong> 1 point each</li>
            </ul>
            <p>In case of a tie in score, the researcher with publications spanning fewer years (more concentrated research) is selected.</p>
        </div>
    </div>
</div>

{% endblock %}

