{% extends 'base.html' %}
{% load static %}
{% load user_filters %}

{% block title %}Departmental Research - CSE UAP{% endblock %}

{% block content %}
<div class="container">
    <section class="research-page-section">
        <!-- Header -->
        <div class="research-header">
            <div class="header-content">
                <div class="header-text">
                    <h1>Departmental Research</h1>
                    <p class="subtitle">Publications and research contributions from our faculty members</p>
                </div>
                <a href="{% url 'people:faculty_list' %}" class="back-link">
                    ← Back to Faculty
                </a>
            </div>
        </div>

        <!-- Time Period Filter Bar -->
        <div class="period-filter-bar">
            <div class="filter-label">Time Period:</div>
            <div class="filter-buttons">
                <a href="?period=all_time&tab={{ request.GET.tab|default:'stats' }}" class="filter-btn {% if period == 'all_time' %}active{% endif %}" data-period="all_time">
                    All Time
                </a>
                <a href="?period=last_2_years&tab={{ request.GET.tab|default:'stats' }}" class="filter-btn {% if period == 'last_2_years' %}active{% endif %}" data-period="last_2_years">
                    Last 2 Years
                </a>
                <a href="?period=current_year&tab={{ request.GET.tab|default:'stats' }}" class="filter-btn {% if period == 'current_year' %}active{% endif %}" data-period="current_year">
                    {{ current_year }}
                </a>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-btn {% if request.GET.tab != 'faculty' and request.GET.tab != 'publications' %}active{% endif %}" data-tab="stats">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Statistics
                </button>
                <button class="tab-btn {% if request.GET.tab == 'faculty' %}active{% endif %}" data-tab="faculty">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Faculty Scores
                </button>
                <button class="tab-btn {% if request.GET.tab == 'publications' %}active{% endif %}" data-tab="publications">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    All Publications
                </button>
            </div>

            <!-- Tab Content -->
            <!-- Statistics Tab -->
            <div class="tab-content {% if request.GET.tab != 'faculty' and request.GET.tab != 'publications' %}active{% endif %}" id="stats-tab">
                <div class="stats-section">
            <h2 class="section-title">Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ total_pubs }}</div>
                    <div class="stat-label">Total Publications</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_citations|floatformat:0 }}</div>
                    <div class="stat-label">Total Citations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ avg_pubs_per_faculty }}</div>
                    <div class="stat-label">Avg. Publications per Faculty</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ num_faculty }}</div>
                    <div class="stat-label">Current Faculty Members</div>
                </div>
            </div>

            <!-- Ranking Breakdown -->
            <div class="ranking-stats">
                <h3 class="subsection-title">Publications by Ranking</h3>
                <div class="ranking-grid">
                    {% for ranking_code, data in stats_by_ranking.items %}
                    <div class="ranking-card">
                        <div class="ranking-label">{{ data.label }}</div>
                        <div class="ranking-value">{{ data.count }}</div>
                        <div class="ranking-score">Score: {{ data.score }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
                </div>
            </div>

            <!-- Faculty Scores Tab -->
            <div class="tab-content {% if request.GET.tab == 'faculty' %}active{% endif %}" id="faculty-tab">
                <div class="faculty-scores-section">
                    <div class="section-header-with-info">
                        <h2 class="section-title">Highest Scoring Faculties Designation Wise</h2>
                        <button class="info-btn" id="scoring-info-btn" title="How is research score calculated?">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Top Researchers by Designation -->
                    <div class="top-researchers-grid">
                        {% for designation in top_by_designation.keys %}
                            {% with top_list=top_by_designation|get_item:designation %}
                            {% if top_list %}
                            <div class="top-researchers-card">
                                <div class="top-researchers-list">
                                    {% for item in top_list %}
                                    <a href="{% url 'people:faculty_detail' item.faculty.pk %}" class="top-researcher-item">
                                        <div class="researcher-card">
                                            <div class="researcher-card-image">
                                                <img src="{% if item.faculty.profile_pic %}/media/{{ item.faculty.profile_pic.name }}{% else %}{% static 'defaults/people.png' %}{% endif %}" alt="{{ item.faculty.name }}">
                                                <div class="researcher-card-overlay">
                                                    <div class="researcher-card-info">
                                                        <h3 class="researcher-name">{{ item.faculty.name }}</h3>
                                                        <div class="researcher-meta">
                                                            <span class="researcher-score">Score: {{ item.score }}</span>
                                                            <span class="researcher-citation">Citations: {{ item.citations|floatformat:0 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <h3 class="designation-title-small">{{ designation }}</h3>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <div class="scores-table-container">
                        <table class="scores-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Faculty Name</th>
                                    <th>Publications</th>
                                    <th>Score</th>
                                    <th>Citations</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in faculty_scores %}
                                <tr>
                                    <td class="rank-cell">
                                        {% if forloop.counter <= 3 %}
                                            <span class="top-rank">#{{ forloop.counter }}</span>
                                        {% else %}
                                            #{{ forloop.counter }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'people:faculty_detail' item.faculty.pk %}" class="faculty-link">
                                            {{ item.faculty.name }}
                                        </a>
                                    </td>
                                    <td>{{ item.publication_count }}</td>
                                    <td class="score-cell">{{ item.score }}</td>
                                    <td>{{ item.citations|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="empty-message">No publications found for the selected period.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Publications Tab -->
            <div class="tab-content {% if request.GET.tab == 'publications' %}active{% endif %}" id="publications-tab">
                <div class="publications-section">
                    <h2 class="section-title">All Publications</h2>
                    <div class="publications-table-container">
                        <table class="publications-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Year</th>
                                    <th>Type</th>
                                    <th>Ranking</th>
                                    <th>Faculty</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pub in publications %}
                                <tr>
                                    <td class="title-cell">{{ pub.title }}</td>
                                    <td>{{ pub.pub_year }}</td>
                                    <td>
                                        <span class="type-badge type-{{ pub.type }}">
                                            {{ pub.get_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="ranking-badge ranking-{{ pub.ranking }}">
                                            {{ pub.get_ranking_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'people:faculty_detail' pub.faculty.pk %}" class="faculty-link">
                                            {{ pub.faculty.name }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if pub.link %}
                                        <a href="{{ pub.link }}" target="_blank" rel="noopener noreferrer" class="read-paper-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                                <polyline points="15 3 21 3 21 9"></polyline>
                                                <line x1="10" y1="14" x2="21" y2="3"></line>
                                            </svg>
                                            Read Paper
                                        </a>
                                        {% else %}
                                        <span class="no-link">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="empty-message">No publications found for the selected period.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
.research-page-section {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.research-header {
    margin-bottom: 2rem;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-text h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
    margin: 0;
}

.back-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
}

.back-link:hover {
    border-color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 5%, transparent);
}

/* Period Filter Bar */
.period-filter-bar {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-label {
    font-weight: 600;
    color: var(--text-primary);
}

.filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
}

.filter-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.filter-btn.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

/* Statistics Section */
.stats-section {
    margin-bottom: 3rem;
}

.section-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 1.5rem 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.subsection-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 2rem 0 1rem 0;
}

.ranking-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
}

.ranking-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
}

.ranking-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.ranking-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 0.25rem;
}

.ranking-score {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Faculty Scores Section */
.faculty-scores-section {
    margin-bottom: 3rem;
}

.scores-table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.scores-table {
    width: 100%;
    border-collapse: collapse;
}

.scores-table thead {
    background: var(--bg-tertiary);
}

.scores-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
}

.scores-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.scores-table tbody tr:hover {
    background: color-mix(in srgb, var(--color-primary) 3%, transparent);
}

.rank-cell {
    font-weight: 600;
    color: var(--text-secondary);
}

.top-rank {
    color: var(--color-primary);
    font-size: 1.1rem;
}

.faculty-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
}

.faculty-link:hover {
    text-decoration: underline;
}

.score-cell {
    font-weight: 700;
    color: var(--color-primary);
    font-size: 1.1rem;
}

/* Publications Section */
.publications-section {
    margin-bottom: 3rem;
}

.publications-table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow-x: auto;
}

.publications-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.publications-table thead {
    background: var(--bg-tertiary);
}

.publications-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
    white-space: nowrap;
}

.publications-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.publications-table tbody tr:hover {
    background: color-mix(in srgb, var(--color-primary) 3%, transparent);
}

.title-cell {
    max-width: 400px;
    word-wrap: break-word;
}

.type-badge,
.ranking-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.type-journal {
    background: color-mix(in srgb, #3b82f6 15%, transparent);
    color: #3b82f6;
    border: 1px solid color-mix(in srgb, #3b82f6 30%, transparent);
}

.type-conf {
    background: color-mix(in srgb, #10b981 15%, transparent);
    color: #10b981;
    border: 1px solid color-mix(in srgb, #10b981 30%, transparent);
}

.type-bookchapter {
    background: color-mix(in srgb, #8b5cf6 15%, transparent);
    color: #8b5cf6;
    border: 1px solid color-mix(in srgb, #8b5cf6 30%, transparent);
}

.type-other {
    background: color-mix(in srgb, #6b7280 15%, transparent);
    color: #6b7280;
    border: 1px solid color-mix(in srgb, #6b7280 30%, transparent);
}

.ranking-q1 {
    background: color-mix(in srgb, #10b981 15%, transparent);
    color: #10b981;
    border: 1px solid color-mix(in srgb, #10b981 30%, transparent);
}

.ranking-q2 {
    background: color-mix(in srgb, #3b82f6 15%, transparent);
    color: #3b82f6;
    border: 1px solid color-mix(in srgb, #3b82f6 30%, transparent);
}

.ranking-q3 {
    background: color-mix(in srgb, #f59e0b 15%, transparent);
    color: #f59e0b;
    border: 1px solid color-mix(in srgb, #f59e0b 30%, transparent);
}

.ranking-q4 {
    background: color-mix(in srgb, #ef4444 15%, transparent);
    color: #ef4444;
    border: 1px solid color-mix(in srgb, #ef4444 30%, transparent);
}

.ranking-a1,
.ranking-a2,
.ranking-a3,
.ranking-a4 {
    background: color-mix(in srgb, #8b5cf6 15%, transparent);
    color: #8b5cf6;
    border: 1px solid color-mix(in srgb, #8b5cf6 30%, transparent);
}

.ranking-not_indexed {
    background: color-mix(in srgb, #6b7280 15%, transparent);
    color: #6b7280;
    border: 1px solid color-mix(in srgb, #6b7280 30%, transparent);
}

.read-paper-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: var(--color-primary);
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.read-paper-btn:hover {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px color-mix(in srgb, var(--color-primary) 30%, transparent);
}

.no-link {
    color: var(--text-secondary);
    font-style: italic;
}

.empty-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-style: italic;
}

/* Top Researchers Cards */
.top-researchers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    margin-bottom: 2.5rem;
}

.top-researchers-card {
    background: transparent;
    border: none;
    padding: 0;
    box-shadow: none;
}

.top-researchers-list {
    display: flex;
    justify-content: center;
    gap: 0;
}

.designation-title-small {
    font-size: 1rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0.75rem 0 0 0;
    text-align: center;
    padding: 0;
    border: none;
}

.top-researcher-item {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-origin: center bottom;
    transform-style: preserve-3d;
    will-change: transform;
    position: relative;
    overflow: visible;
    perspective: 1200px;
    perspective-origin: 50% 100%;
}

.top-researcher-item:hover {
    transform: scale(1.08) translateY(-8px) rotateX(12deg) rotateY(0deg) rotateZ(0deg);
    z-index: 100;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.researcher-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    height: 100%;
    min-height: 280px;
    width: 200px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform-style: preserve-3d;
    transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
}

.top-researcher-item:hover .researcher-card {
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    border-color: var(--color-primary);
    border-width: 2px;
}

.researcher-card-image {
    width: 100%;
    height: 100%;
    min-height: 280px;
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.researcher-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.top-researcher-item:hover .researcher-card-image img {
    transform: scale(1.05);
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.researcher-card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.7) 50%, rgba(0, 0, 0, 0) 100%);
    padding: 1.25rem 1rem 1rem 1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.top-researcher-item:hover .researcher-card-overlay {
    padding: 1.5rem 1.25rem 1.25rem 1.25rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.75) 50%, rgba(0, 0, 0, 0) 100%);
}

.researcher-card-info {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    position: relative;
}

.researcher-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: white;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.top-researcher-item:hover .researcher-name {
    font-size: 1.2rem;
}

.researcher-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin: 0;
}

.researcher-score,
.researcher-citation {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    font-weight: 500;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.top-researcher-item:hover .researcher-score,
.top-researcher-item:hover .researcher-citation {
    font-size: 0.85rem;
}

/* Section Header with Info Button */
.section-header-with-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    gap: 1rem;
}

.info-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
}

.info-btn:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
    transform: scale(1.1);
}

.info-btn svg {
    width: 20px;
    height: 20px;
}

/* Info Modal */
.info-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.info-modal.active {
    display: flex;
}

.info-modal-content {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 2rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    position: relative;
}

.info-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.info-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.info-modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.info-modal-close svg {
    width: 24px;
    height: 24px;
}

.scoring-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.scoring-table th,
.scoring-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.scoring-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
}

.scoring-table td {
    color: var(--text-secondary);
}

.scoring-table tr:last-child td {
    border-bottom: none;
}

.scoring-explanation {
    margin-top: 1.5rem;
    padding: 1rem;
    background: color-mix(in srgb, var(--color-primary) 8%, transparent);
    border-radius: 10px;
    border-left: 4px solid var(--color-primary);
}

.scoring-explanation p {
    margin: 0;
    color: var(--text-primary);
    line-height: 1.6;
}

/* Tabs */
.tabs-container {
    margin-bottom: 2rem;
}

.tabs-nav {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Lexend', sans-serif;
    margin-bottom: -2px;
}

.tab-btn:hover {
    color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 5%, transparent);
}

.tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 8%, transparent);
}

.tab-btn svg {
    width: 18px;
    height: 18px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .ranking-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .publications-table-container {
        overflow-x: auto;
    }
    
    .tabs-nav {
        flex-direction: column;
        gap: 0;
    }
    
    .tab-btn {
        width: 100%;
        justify-content: flex-start;
        border-bottom: 1px solid var(--border-color);
        border-left: 3px solid transparent;
        margin-bottom: 0;
    }
    
    .tab-btn.active {
        border-left-color: var(--color-primary);
        border-bottom-color: var(--border-color);
    }
    
    .top-researchers-list {
        flex-direction: column;
        align-items: center;
    }
    
    .top-researchers-grid {
        grid-template-columns: 1fr;
    }
    
    .researcher-card {
        width: 100%;
        max-width: 300px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Function to update URL with tab parameter
    function updateTabInURL(tab) {
        const url = new URL(window.location);
        url.searchParams.set('tab', tab);
        // Preserve period parameter if it exists
        const period = url.searchParams.get('period') || 'all_time';
        window.history.pushState({}, '', `?period=${period}&tab=${tab}`);
    }
    
    // Function to update filter button hrefs with current tab
    function updateFilterButtonHrefs(currentTab) {
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(button => {
            const period = button.dataset.period;
            if (period) {
                button.href = `?period=${period}&tab=${currentTab}`;
            }
        });
    }
    
    // Function to switch tabs
    function switchTab(targetTab) {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked button and corresponding content
        const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
        const activeContent = document.getElementById(targetTab + '-tab');
        
        if (activeButton) activeButton.classList.add('active');
        if (activeContent) activeContent.classList.add('active');
        
        // Update URL and localStorage
        updateTabInURL(targetTab);
        localStorage.setItem('research_page_tab', targetTab);
        
        // Update filter button hrefs to preserve current tab
        updateFilterButtonHrefs(targetTab);
    }
    
    // Initialize tab from URL or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const urlTab = urlParams.get('tab');
    const storedTab = localStorage.getItem('research_page_tab');
    const initialTab = urlTab || storedTab || 'stats';
    
    // Initialize filter button hrefs with current tab
    updateFilterButtonHrefs(initialTab);
    
    if (initialTab !== 'stats') {
        switchTab(initialTab);
    }
    
    // Handle tab button clicks
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            switchTab(targetTab);
        });
    });
    
    // Info modal functionality
    const infoBtn = document.getElementById('scoring-info-btn');
    const infoModal = document.getElementById('scoring-info-modal');
    const closeModal = document.getElementById('close-info-modal');
    
    if (infoBtn && infoModal) {
        infoBtn.addEventListener('click', function() {
            infoModal.classList.add('active');
        });
    }
    
    if (closeModal && infoModal) {
        closeModal.addEventListener('click', function() {
            infoModal.classList.remove('active');
        });
    }
    
    // Close modal when clicking outside
    if (infoModal) {
        infoModal.addEventListener('click', function(e) {
            if (e.target === infoModal) {
                infoModal.classList.remove('active');
            }
        });
    }
});
</script>

<!-- Info Modal -->
<div class="info-modal" id="scoring-info-modal">
    <div class="info-modal-content">
        <div class="info-modal-header">
            <h3 class="info-modal-title">Research Score Calculation</h3>
            <button class="info-modal-close" id="close-info-modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="info-modal-body">
            <p>The research score is calculated based on the ranking of each publication:</p>
            <table class="scoring-table">
                <thead>
                    <tr>
                        <th>Ranking</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Q1</td>
                        <td>{{ scoring_system.q1 }} points</td>
                    </tr>
                    <tr>
                        <td>Q2</td>
                        <td>{{ scoring_system.q2 }} points</td>
                    </tr>
                    <tr>
                        <td>Q3</td>
                        <td>{{ scoring_system.q3 }} points</td>
                    </tr>
                    <tr>
                        <td>Q4</td>
                        <td>{{ scoring_system.q4 }} points</td>
                    </tr>
                    <tr>
                        <td>A1</td>
                        <td>{{ scoring_system.a1 }} points</td>
                    </tr>
                    <tr>
                        <td>A2</td>
                        <td>{{ scoring_system.a2 }} points</td>
                    </tr>
                    <tr>
                        <td>A3</td>
                        <td>{{ scoring_system.a3 }} points</td>
                    </tr>
                    <tr>
                        <td>A4</td>
                        <td>{{ scoring_system.a4 }} points</td>
                    </tr>
                    <tr>
                        <td>Not Indexed</td>
                        <td>{{ scoring_system.not_indexed }} point</td>
                    </tr>
                </tbody>
            </table>
            <div class="scoring-explanation">
                <p><strong>How it works:</strong> Each faculty member's total research score is the sum of points from all their publications within the selected time period. Higher-ranked publications contribute more points to the overall score.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

