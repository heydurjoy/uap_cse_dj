{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Permission Objects - CSE UAP{% endblock %}

{% block content %}
<div class="container">
    <section class="manage-permissions-page">
        <div class="profile-header">
            <a href="{% url 'people:user_profile' %}" class="back-link">‚Üê Back to Profile</a>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <h1 class="page-title">Manage Permission Objects</h1>
                <button type="button" onclick="openPermissionGuideModal()" class="btn-secondary" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; white-space: nowrap;">
                    üìñ Permission Guide
                </button>
            </div>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="search-section" style="margin-bottom: 1.5rem;">
            <form method="get" action="{% url 'people:manage_permissions' %}" id="search-form" class="search-form" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <!-- Category Filter -->
                <select 
                    name="category" 
                    id="category_filter"
                    class="filter-select"
                    style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);"
                >
                    {% for value, label in category_choices %}
                        <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- Search Input -->
                <input 
                    type="text" 
                    name="search" 
                    id="search_input"
                    placeholder="Search by codename, name, or description..." 
                    value="{{ search_query }}"
                    class="search-input"
                    style="padding: 0.75rem; flex: 1; min-width: 250px; max-width: 500px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);"
                >
                {% if search_query or category_filter != 'all' %}
                    <a href="{% url 'people:manage_permissions' %}" class="btn-secondary" style="padding: 0.75rem 1.5rem; text-decoration: none; white-space: nowrap;">Clear</a>
                {% endif %}
            </form>
        </div>
        
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                Manage permission objects that can be granted to users. These define what actions users can perform in the system.
            </p>
            <a href="{% url 'people:create_permission' %}" class="btn-primary" style="padding: 0.75rem 1.5rem; text-decoration: none; white-space: nowrap;">
                + Create Permission
            </a>
        </div>
        
        <div class="permissions-list">
            {% if permissions %}
                <div class="permissions-table-container" style="background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);">
                    <table class="permissions-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: color-mix(in srgb, var(--color-primary) 10%, var(--bg-secondary)); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary);">Codename</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary);">Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary);">Category</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary);">Priority</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary);">Requires Role</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary);">Status</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for permission in permissions %}
                                <tr class="permission-row" style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;">
                                    <td style="padding: 1rem; color: var(--text-primary); font-family: monospace; font-size: 0.9rem;">
                                        <strong>{{ permission.codename }}</strong>
                                    </td>
                                    <td style="padding: 1rem; color: var(--text-primary);">
                                        {{ permission.name }}
                                        {% if permission.description %}
                                            <br><small style="color: var(--text-secondary); font-size: 0.85rem;">{{ permission.description|truncatewords:10 }}</small>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem;">
                                        <span style="padding: 0.25rem 0.75rem; background: color-mix(in srgb, var(--color-primary) 15%, transparent); color: var(--color-primary); border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                                            {{ permission.get_category_display|default:"‚Äî" }}
                                        </span>
                                    </td>
                                    <td style="padding: 1rem; text-align: center; color: var(--text-primary);">
                                        {{ permission.priority }}
                                    </td>
                                    <td style="padding: 1rem; text-align: center;">
                                        {% if permission.requires_role %}
                                            <span style="color: var(--text-primary); font-size: 0.85rem;">
                                                {{ permission.requires_role|join:", "|title }}
                                            </span>
                                        {% else %}
                                            <span style="color: var(--text-secondary);">Any</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem; text-align: center;">
                                        {% if permission.is_active %}
                                            <span style="color: #28a745; font-weight: 600;">Active</span>
                                        {% else %}
                                            <span style="color: #dc3545; font-weight: 600;">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 1rem; text-align: center;">
                                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                            <a href="{% url 'people:edit_permission' permission.pk %}" class="action-btn edit-btn" title="Edit">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </a>
                                            <a href="{% url 'people:delete_permission' permission.pk %}" class="action-btn delete-btn" title="Delete">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="3 6 5 6 21 6"></polyline>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-results" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No permissions found.</p>
                    {% if search_query %}
                        <p>Try a different search term.</p>
                    {% else %}
                        <p>No permission objects in the system.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Permission Guide Modal -->
<div id="permissionGuideModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: var(--bg-primary); margin: 5% auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: var(--text-primary); margin: 0;">Permission Objects Guide</h2>
            <button onclick="closePermissionGuideModal()" style="background: none; border: none; font-size: 2rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        
        <div style="color: var(--text-primary); line-height: 1.8;">
            <h3 style="color: var(--color-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">What are Permission Objects?</h3>
            <p>Permission objects define what actions users can perform in the system. Each permission has a unique codename that is used throughout the application to check if a user has access to specific features.</p>
            
            <h3 style="color: var(--color-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Permission Fields Explained</h3>
            <ul style="margin-left: 1.5rem;">
                <li><strong>Codename:</strong> A unique identifier (e.g., 'post_notices', 'manage_courses'). Must be lowercase with underscores. This is what you use in code to check permissions.</li>
                <li><strong>Name:</strong> Human-readable name displayed to users (e.g., 'Post Notices', 'Manage Courses').</li>
                <li><strong>Description:</strong> Detailed explanation of what this permission allows.</li>
                <li><strong>Category:</strong> Groups permissions by area:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li><strong>Office:</strong> Notices, routines, admission results</li>
                        <li><strong>Clubs:</strong> Club management</li>
                        <li><strong>Designs:</strong> Feature cards, head message, calendars</li>
                        <li><strong>User Management:</strong> User permissions, publications</li>
                        <li><strong>Academics:</strong> Courses, curricula</li>
                    </ul>
                </li>
                <li><strong>Requires Role:</strong> Comma-separated list of user types that can have this permission (e.g., 'faculty,officer'). Leave empty for any role.</li>
                <li><strong>Priority:</strong> Display order (lower = more important). Used for sorting in permission lists.</li>
                <li><strong>Is Active:</strong> Whether this permission is currently available for assignment.</li>
            </ul>
            
            <h3 style="color: var(--color-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">How to Create a Permission</h3>
            <ol style="margin-left: 1.5rem;">
                <li>Click "Create Permission" button</li>
                <li>Fill in the required fields:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li><strong>Codename:</strong> Use lowercase with underscores (e.g., 'manage_curricula')</li>
                        <li><strong>Name:</strong> Use title case (e.g., 'Manage Curricula')</li>
                        <li><strong>Category:</strong> Select the appropriate category</li>
                        <li><strong>Requires Role:</strong> Enter comma-separated roles (e.g., 'faculty,officer') or leave empty</li>
                        <li><strong>Priority:</strong> Use 10, 20, 30, etc. for grouping</li>
                    </ul>
                </li>
                <li>Click "Create Permission"</li>
            </ol>
            
            <h3 style="color: var(--color-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Using Permissions in Code</h3>
            <p>To check if a user has a permission in templates:</p>
            <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.9rem;"><code>{% verbatim %}{% if user|has_granted_permission:'post_notices' %}
    <!-- Show content -->
{% endif %}{% endverbatim %}</code></pre>
            
            <p style="margin-top: 1rem;">To check in Python views:</p>
            <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.9rem;"><code>if request.user.has_permission('post_notices'):
    # User has permission
    pass</code></pre>
            
            <h3 style="color: var(--color-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Important Notes</h3>
            <ul style="margin-left: 1.5rem;">
                <li>Power users can see all options regardless of permissions</li>
                <li>Deleting a permission will not remove it from users who already have it, but it will become inactive</li>
                <li>Always use the codename (not the name) when checking permissions in code</li>
                <li>Permissions are case-sensitive - always use lowercase with underscores</li>
            </ul>
        </div>
        
        <div style="margin-top: 2rem; text-align: right;">
            <button onclick="closePermissionGuideModal()" class="btn-primary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<style>
.manage-permissions-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.back-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 1rem;
    display: inline-block;
    transition: color 0.3s ease;
}

.back-link:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0.5rem 0 0 0;
}

.btn-primary {
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: var(--color-primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--glow-shadow);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: var(--bg-secondary);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.permission-row:hover {
    background: color-mix(in srgb, var(--color-primary) 5%, var(--bg-secondary)) !important;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
}

.edit-btn {
    background: color-mix(in srgb, var(--color-primary) 10%, var(--bg-secondary));
    color: var(--color-primary);
    border: 1px solid var(--color-primary);
}

.edit-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-2px);
}

.delete-btn {
    background: color-mix(in srgb, #dc3545 10%, var(--bg-secondary));
    color: #dc3545;
    border: 1px solid #dc3545;
}

.delete-btn:hover {
    background: #dc3545;
    color: white;
    transform: translateY(-2px);
}

.action-btn svg {
    width: 16px;
    height: 16px;
}

.modal-content pre {
    margin: 0.5rem 0;
}

.modal-content code {
    font-family: 'Courier New', monospace;
}

@media (max-width: 768px) {
    .permissions-table-container {
        overflow-x: auto;
    }
    
    .permissions-table {
        min-width: 800px;
    }
}
</style>

<script>
    // Real-time search functionality
    (function() {
        let searchTimeout;
        const searchInput = document.getElementById('search_input');
        const categoryFilter = document.getElementById('category_filter');
        const searchForm = document.getElementById('search-form');
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    searchForm.submit();
                }, 500);
            });
        }
        
        if (categoryFilter) {
            categoryFilter.addEventListener('change', function() {
                searchForm.submit();
            });
        }
    })();
    
    // Modal functions
    function openPermissionGuideModal() {
        document.getElementById('permissionGuideModal').style.display = 'block';
    }
    
    function closePermissionGuideModal() {
        document.getElementById('permissionGuideModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('permissionGuideModal');
        if (event.target == modal) {
            closePermissionGuideModal();
        }
    }
</script>
{% endblock %}

